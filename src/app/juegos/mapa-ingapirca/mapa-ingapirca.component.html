<!-- mapa-ingapirca.component.html - FLUJO COMPLETO CON CAPAS -->

<div class="exploracion-container">
    <!-- Header con progreso -->
    <div class="header-exploracion">
        <p-card>
            <div class="flex justify-content-between align-items-center">
                <div>
                    <h2>Exploraci√≥n de Ingapirca</h2>
                    <p class="subtitle">Descubre los secretos del complejo arqueol√≥gico Ca√±ari-Inca</p>
                </div>
                <div class="progreso-info">
                    <span class="puntos-visitados">
                        {{ puntosVisitados() }} / {{ puntos.length }} puntos visitados
                    </span>
                    <p-progressBar
                        [value]="porcentajeVisitados()"
                        [showValue]="false">
                    </p-progressBar>
                </div>
            </div>
        </p-card>
    </div>

    <!-- Mapa SVG -->
    <div class="mapa-container">
        <svg viewBox="0 0 1000 700" class="mapa-svg" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <pattern id="terreno" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
                    <rect width="100" height="100" fill="#e8dcc4"/>
                    <circle cx="10" cy="10" r="2" fill="#d4c4a8" opacity="0.3"/>
                    <circle cx="50" cy="50" r="2" fill="#d4c4a8" opacity="0.3"/>
                </pattern>

                <radialGradient id="glowBronce">
                    <stop offset="0%" stop-color="#CD7F32" stop-opacity="0.4"/>
                    <stop offset="100%" stop-color="#CD7F32" stop-opacity="0"/>
                </radialGradient>
            </defs>

            <rect width="1000" height="700" fill="url(#terreno)"/>

            <!-- ‚¨áÔ∏è CAMINOS DIN√ÅMICOS -->
            @for (camino of caminosSVG; track $index) {
                <path
                    [attr.d]="camino"
                    stroke="#8B4513"
                    stroke-width="2.5"
                    fill="none"
                    stroke-dasharray="10,5"
                    opacity="0.25"
                    stroke-linecap="round"
                    class="camino-punto"/>
            }

            <!-- Puntos de inter√©s -->
            @for (punto of puntos; track punto.id) {
                <g class="punto-interes"
                   [class.desbloqueado]="punto.desbloqueado"
                   [class.visitado]="punto.visitado"
                   [class.bloqueado]="!punto.desbloqueado"
                   (click)="seleccionarPunto(punto)"
                   [pTooltip]="punto.nombre"
                   tooltipPosition="top">

                    <!-- Glow effect -->
                    @if (punto.desbloqueado && !punto.visitado) {
                        <circle
                            [attr.cx]="punto.coordenadaX * 10"
                            [attr.cy]="punto.coordenadaY * 10"
                            r="35"
                            fill="url(#glowBronce)"
                            class="glow-pulse"
                            pointer-events="none"/>
                    }

                    <!-- C√≠rculo principal -->
                    <circle
                        [attr.cx]="punto.coordenadaX * 10"
                        [attr.cy]="punto.coordenadaY * 10"
                        r="25"
                        [attr.fill]="punto.desbloqueado ? '#8B4513' : '#cccccc'"
                        [attr.stroke]="punto.visitado ? '#FFD700' : '#8B4513'"
                        stroke-width="3"
                        class="punto-circulo"/>

                    <!-- Icono -->
                    <text
                        [attr.x]="punto.coordenadaX * 10"
                        [attr.y]="punto.coordenadaY * 10 + 8"
                        text-anchor="middle"
                        font-size="24"
                        [attr.fill]="punto.desbloqueado ? '#ffffff' : '#666666'"
                        pointer-events="none">
                        {{ obtenerEmojiCategoria(punto.categoria) }}
                    </text>

                    <!-- Badge visitado -->
                    @if (punto.visitado) {
                        <g pointer-events="none">
                            <circle
                                [attr.cx]="punto.coordenadaX * 10 + 20"
                                [attr.cy]="punto.coordenadaY * 10 - 20"
                                r="12"
                                fill="#FFD700"
                                stroke="#fff"
                                stroke-width="2"/>
                            <text
                                [attr.x]="punto.coordenadaX * 10 + 20"
                                [attr.y]="punto.coordenadaY * 10 - 15"
                                text-anchor="middle"
                                font-size="14"
                                font-weight="bold"
                                fill="#fff">V</text>
                        </g>
                    }

                    <!-- Candado -->
                    @if (!punto.desbloqueado) {
                        <text
                            [attr.x]="punto.coordenadaX * 10"
                            [attr.y]="punto.coordenadaY * 10 + 8"
                            text-anchor="middle"
                            font-size="20"
                            pointer-events="none">üîí</text>
                    }
                </g>
            }
        </svg>
    </div>

    <!-- Leyenda -->
    <div class="leyenda">
        <p-card>
            <div class="leyenda-items">
                <div class="leyenda-item">
                    <span class="icono-leyenda" style="background: #CD7F32;"></span>
                    <span>Bronce</span>
                </div>
                <div class="leyenda-item">
                    <span class="icono-leyenda" style="background: #C0C0C0;"></span>
                    <span>Plata</span>
                </div>
                <div class="leyenda-item">
                    <span class="icono-leyenda" style="background: #FFD700;"></span>
                    <span>Oro</span>
                </div>
            </div>
        </p-card>
    </div>

    <!-- ========================================
         MODAL 1: CAPAS DEL PUNTO (NUEVO)
         ======================================== -->
    <p-dialog
        [(visible)]="mostrarModalCapas"
        [modal]="true"
        [style]="{width: '90vw', maxWidth: '1000px'}"
        [closable]="true"
        (onHide)="cerrarModalCapas()">

        <ng-template pTemplate="header">
            @if (puntoSeleccionado) {
                <div class="dialog-header">
                    <h2>{{ puntoSeleccionado.nombre }}</h2>
                    @if (puntoSeleccionado.nombreKichwa) {
                        <span class="nombre-kichwa">{{ puntoSeleccionado.nombreKichwa }}</span>
                    }
                </div>
            }
        </ng-template>

        @if (puntoSeleccionado) {
            <!-- Usar componente de capas -->
            <app-capas-punto
                [nombrePunto]="puntoSeleccionado.nombre"
                [capas]="capasPunto"
                (explorarCapa)="abrirExploracionCapa($event)"
                (volver)="cerrarModalCapas()">
            </app-capas-punto>
        }
    </p-dialog>

    <!-- ========================================
         MODAL 2: EXPLORACI√ìN DE CAPA (NUEVO)
         ======================================== -->
    <p-dialog
        [(visible)]="mostrarModalExploracion"
        [modal]="true"
        [style]="{width: '90vw', maxWidth: '1200px', height: '85vh'}"
        [closable]="true"
        (onHide)="cerrarModalExploracion()">

        <ng-template pTemplate="header">
            @if (capaActiva) {
                <div class="exploracion-header">
                    <div>
                        <h2>{{ puntoSeleccionado?.nombre }}</h2>
                        <span class="badge-capa">
                            {{ obtenerIconoCapa(capaActiva.nivelCapa) }} {{ capaActiva.nombre }}
                        </span>
                    </div>
                    <div class="progreso-capa">
                        <span>{{ capaActiva.porcentajeCompletitud }}% completado</span>
                        <p-progressBar [value]="capaActiva.porcentajeCompletitud" [showValue]="false"></p-progressBar>
                    </div>
                </div>
            }
        </ng-template>

        @if (capaActiva) {
            <div class="exploracion-content">
                <!-- Navegaci√≥n de Tabs -->
                <div class="tabs-navegacion">
                    <button class="tab-button" [class.active]="tabActivo === 0" (click)="cambiarTab(0)">
                        üìñ Narrativa
                        @if (capaActiva.narrativaLeida) {
                            <i class="pi pi-check-circle ml-2"></i>
                        }
                    </button>
                    <button class="tab-button" [class.active]="tabActivo === 1" (click)="cambiarTab(1)">
                        üì∏ Fotograf√≠a
                        <span class="badge-tab">{{ capaActiva.fotografiasCompletadas }}/{{ capaActiva.fotografiasRequeridas }}</span>
                    </button>
                    <button class="tab-button" [class.active]="tabActivo === 2" (click)="cambiarTab(2)">
                        üí¨ Di√°logo
                        <span class="badge-tab">{{ capaActiva.dialogosRealizados }}</span>
                    </button>
                    <button class="tab-button" [class.active]="tabActivo === 3" (click)="cambiarTab(3)">
                        üéØ Misi√≥n
                        @if (capaActiva.misionAsociada?.estado) {
                            <i class="pi pi-flag-fill ml-2"></i>
                        }
                    </button>
                </div>

                <!-- Contenido de Tabs -->
                <div class="tab-content">
                    <!-- TAB 1: NARRATIVA -->
                    @if (tabActivo === 0) {
                        <div class="narrativa-panel">
                            <div class="imagen-punto">
                                <img
                                    [src]="puntoSeleccionado?.imagenUrl"
                                    [alt]="puntoSeleccionado?.nombre"
                                    (error)="onImageError($event)">
                            </div>

                            @if (cargandoNarrativa) {
                                <div class="loading-narrativa">
                                    <i class="pi pi-spin pi-spinner" style="font-size: 2rem;"></i>
                                    <p>Generando narrativa con IA...</p>
                                </div>
                            } @else {
                                <div class="narrativa-texto" (click)="saltarAnimacion()">
                                    <p>{{ narrativaVisible }}</p>
                                    @if (narrativaVisible !== narrativaActual) {
                                        <small class="hint"><i class="pi pi-forward"></i> Click para mostrar todo</small>
                                    }
                                </div>
                            }

                            @if (narrativaCompleta && !capaActiva.narrativaLeida) {
                                <div class="narrativa-completada">
                                    <i class="pi pi-check-circle"></i>
                                    <p>¬°Narrativa completada! Nivel Bronce alcanzado</p>
                                </div>
                            }
                        </div>
                    }

                    <!-- TAB 2: FOTOGRAF√çA -->
                    @if (tabActivo === 1) {
                        <div class="fotografia-panel">
                            <h3>Objetivos Fotogr√°ficos</h3>
                            <p class="subtitle">Captura {{ capaActiva.fotografiasRequeridas }} fotograf√≠as para completar esta actividad</p>

                            <div class="objetivos-grid">
                                @for (foto of capaActiva.fotografiasPendientes; track foto.id) {
                                    <div class="objetivo-card" [class.completada]="foto.completada">
                                        <div class="objetivo-header">
                                            <i class="pi" [ngClass]="foto.completada ? 'pi-check-circle' : 'pi-camera'"></i>
                                            <span class="rareza-badge" [class]="'rareza-' + foto.rareza.toLowerCase()">
                                                {{ foto.rareza }}
                                            </span>
                                        </div>
                                        <p>{{ foto.descripcion }}</p>
                                        <small>+{{ foto.descripcion }} puntos</small>

                                        @if (!foto.completada) {
                                            <p-button label="Tomar Foto" icon="pi pi-camera" size="small" class="mt-2"></p-button>
                                            <p-fileUpload
                                                mode="basic"
                                                name="fotografia"
                                                accept="image/*"
                                                [maxFileSize]="5000000"
                                                [auto]="true"
                                                chooseLabel="üì∑ Subir Foto"
                                                chooseIcon="pi pi-upload"
                                                (onSelect)="subirFotografia($event, foto)"
                                                [customUpload]="true"
                                                (uploadHandler)="procesarFotografia($event, foto)">
                                            </p-fileUpload>
                                            <p-button
                                                label="Marcar como Completado"
                                                icon="pi pi-check-circle"
                                                severity="secondary"
                                                [outlined]="true"
                                                size="small"
                                                styleClass="w-full mt-2"
                                                (onClick)="marcarCompletadoManual(foto)">
                                            </p-button>
                                        } @else {
                                            <span class="completado-badge">‚úì Completada</span>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- TAB 3: DI√ÅLOGO -->
                    @if (tabActivo === 2) {
                        <div class="dialogo-panel">
                            <div class="espiritu-avatar">
                                <span class="espiritu-icono">{{ obtenerIconoCapa(capaActiva.nivelCapa) }}</span>
                                <h3>{{ obtenerNombreEspiritu(capaActiva.nivelCapa) }}</h3>
                                <p class="espiritu-nombre-kichwa">{{ capaActiva.nombre }}</p>
                            </div>

                            <div class="dialogo-stats">
                                <p>Di√°logos realizados: <strong>{{ capaActiva.dialogosRealizados }}</strong></p>
                            </div>

                            <div class="dialogo-input">
                                <label for="pregunta-espiritu">
                                    <i class="pi pi-comments"></i> Preg√∫ntale al esp√≠ritu ancestral
                                </label>
                                <textarea
                                    id="pregunta-espiritu"
                                    [(ngModel)]="preguntaDialogo"
                                    placeholder="Pregunta sobre este lugar sagrado, su historia, ceremonias, significado cultural..."
                                    rows="4"
                                    [disabled]="cargandoRespuesta">
            </textarea>

                                <p-button
                                    label="Consultar al Esp√≠ritu"
                                    icon="pi pi-send"
                                    (onClick)="enviarPregunta()"
                                    [disabled]="!preguntaDialogo?.trim() || cargandoRespuesta"
                                    [loading]="cargandoRespuesta"
                                    styleClass="w-full">
                                </p-button>

                                <small class="hint">
                                    <i class="pi pi-info-circle"></i>
                                    El esp√≠ritu ancestral responder√° tus dudas sobre la cultura Ca√±ari
                                </small>
                            </div>
                        </div>
                    }

                    <!-- ‚¨áÔ∏è DI√ÅLOGO DE RESPUESTA DEL ESP√çRITU -->
                    <p-dialog
                        [(visible)]="mostrarRespuestaEspiritu"
                        [modal]="true"
                        [style]="{width: '90vw', maxWidth: '700px'}"
                        [closable]="true"
                        [dismissableMask]="false"
                        styleClass="dialogo-espiritu"
                        (onHide)="cerrarRespuestaEspiritu()">

                        <ng-template pTemplate="header">
                            <div class="dialogo-espiritu-header">
                                <div class="espiritu-avatar-modal">
                                    <span class="espiritu-icono-grande">{{ obtenerIconoCapa(capaActiva?.nivelCapa) }}</span>
                                </div>
                                <div>
                                    <h2>{{ nombreEspirituActual }}</h2>
                                    <p class="espiritu-subtitulo">Esp√≠ritu Ancestral Ca√±ari</p>
                                </div>
                            </div>
                        </ng-template>

                        <div class="dialogo-espiritu-content">
                            <!-- Pregunta del usuario -->
                            <div class="pregunta-usuario">
                                <div class="pregunta-label">
                                    <i class="pi pi-user"></i>
                                    <span>Tu pregunta:</span>
                                </div>
                                <p>"{{ preguntaActual || 'Sin pregunta' }}"</p>
                            </div>

                            <!-- Respuesta del esp√≠ritu -->
                            <div class="respuesta-espiritu" (click)="saltarAnimacionEspiritu()">
                                <div class="respuesta-label">
                                    <i class="pi pi-star"></i>
                                    <span>Respuesta del esp√≠ritu:</span>
                                </div>

                                @if (cargandoRespuesta) {
                                    <div class="loading-respuesta">
                                        <i class="pi pi-spin pi-spinner" style="font-size: 2rem;"></i>
                                        <p>El esp√≠ritu est√° meditando tu pregunta...</p>
                                    </div>
                                } @else {
                                    <p class="texto-respuesta">{{ respuestaEspirituVisible }}</p>

                                    @if (!respuestaCompletaEspiritu) {
                                        <small class="hint-click">
                                            <i class="pi pi-hand-pointer"></i> Click para mostrar todo
                                        </small>
                                    }
                                }
                            </div>
                        </div>

                        <ng-template pTemplate="footer">
                            <p-button
                                label="Entendido"
                                icon="pi pi-check"
                                (onClick)="cerrarRespuestaEspiritu()"
                                styleClass="w-full">
                            </p-button>
                        </ng-template>
                    </p-dialog>

                    <!-- TAB 4: MISI√ìN -->
                    @if (tabActivo === 3) {
                        <div class="mision-panel">
                            @if (capaActiva.misionAsociada) {
                                <div class="mision-card">
                                    <h3>{{ capaActiva.misionAsociada.titulo }}</h3>
                                    <p>{{ capaActiva.misionAsociada.descripcion }}</p>
                                    <p-progressBar [value]="capaActiva.misionAsociada.progreso" [showValue]="true"></p-progressBar>
                                </div>
                            } @else {
                                <div class="sin-mision">
                                    <i class="pi pi-info-circle"></i>
                                    <p>No hay misiones asociadas a esta capa temporal</p>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        <ng-template pTemplate="footer">
            <div class="footer-exploracion">
                <p-button label="Volver a Capas" icon="pi pi-arrow-left" severity="secondary" (onClick)="volverACapas()"></p-button>
                <p-button label="Salir" icon="pi pi-times" (onClick)="cerrarModalExploracion()"></p-button>
            </div>
        </ng-template>
    </p-dialog>

    <p-toast />
    <script
        src="https://code.responsivevoice.org/responsivevoice.js?key=Lb9v6u8X"></script>
</div>
