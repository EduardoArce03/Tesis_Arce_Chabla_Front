<!-- mapa-ingapirca.component.html -->
<div class="exploracion-container">
    <!-- Header con progreso -->
    <div class="header-exploracion">
        <p-card>
            <div class="flex justify-content-between align-items-center">
                <div>
                    <h2>Exploraci√≥n de Ingapirca</h2>
                    <p class="subtitle">Descubre los secretos del complejo arqueol√≥gico Ca√±ari-Inca</p>
                </div>
                <div class="progreso-info">
          <span class="puntos-visitados">
            {{ (puntos | filter:'visitado':true).length }} / {{ puntos.length }} puntos visitados
          </span>
                    <p-progressBar
                        [value]="((puntos | filter:'visitado':true).length / puntos.length) * 100"
                        [showValue]="false">
                    </p-progressBar>
                </div>
            </div>
        </p-card>
    </div>

    <!-- Mapa SVG -->
    <div class="mapa-container">
        <svg
            viewBox="0 0 1000 700"
            class="mapa-svg"
            xmlns="http://www.w3.org/2000/svg">

            <!-- Fondo del mapa (imagen o formas) -->
            <defs>
                <pattern id="terreno" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
                    <rect width="100" height="100" fill="#e8dcc4"/>
                    <circle cx="10" cy="10" r="2" fill="#d4c4a8" opacity="0.3"/>
                    <circle cx="50" cy="50" r="2" fill="#d4c4a8" opacity="0.3"/>
                    <circle cx="90" cy="80" r="2" fill="#d4c4a8" opacity="0.3"/>
                </pattern>
            </defs>

            <rect width="1000" height="700" fill="url(#terreno)"/>

            <!-- Caminos decorativos -->
            <path
                d="M 300,400 Q 500,300 700,500"
                stroke="#8B4513"
                stroke-width="3"
                fill="none"
                stroke-dasharray="10,5"
                opacity="0.3"/>

            <path
                d="M 350,550 Q 450,450 650,300"
                stroke="#8B4513"
                stroke-width="3"
                fill="none"
                stroke-dasharray="10,5"
                opacity="0.3"/>

            <!-- Puntos de inter√©s -->
            <g *ngFor="let punto of puntos"
               [attr.transform]="'translate(' + (punto.coordenadas.x * 10) + ',' + (punto.coordenadas.y * 10) + ')'"
               class="punto-interes"
               [class.desbloqueado]="punto.desbloqueado"
               [class.visitado]="punto.visitado"
               [class.bloqueado]="!punto.desbloqueado"
               (click)="seleccionarPunto(punto)"
               [pTooltip]="punto.nombre"
               tooltipPosition="top">

                <!-- Glow effect para puntos desbloqueados -->
                <circle
                    *ngIf="punto.desbloqueado && !punto.visitado"
                    r="35"
                    [attr.fill]="obtenerColorNivel(punto.nivelDescubrimiento)"
                    opacity="0.2"
                    class="glow-pulse"/>

                <!-- C√≠rculo principal del punto -->
                <circle
                    r="25"
                    [attr.fill]="punto.desbloqueado ? obtenerColorNivel(punto.nivelDescubrimiento) : '#cccccc'"
                    [attr.stroke]="punto.visitado ? '#FFD700' : '#8B4513'"
                    stroke-width="3"
                    class="punto-circulo"/>

                <!-- Icono del punto -->
                <text
                    text-anchor="middle"
                    dy="8"
                    font-size="24"
                    [attr.fill]="punto.desbloqueado ? '#ffffff' : '#666666'">
                    {{ obtenerIconoCategoria(punto.categoria) === 'pi-sun' ? '‚òÄ' :
                    obtenerIconoCategoria(punto.categoria) === 'pi-map' ? 'üó∫' :
                        obtenerIconoCategoria(punto.categoria) === 'pi-home' ? 'üè†' :
                            obtenerIconoCategoria(punto.categoria) === 'pi-box' ? 'üì¶' :
                                obtenerIconoCategoria(punto.categoria) === 'pi-eye' ? 'üëÅ' : '‚ú®' }}
                </text>

                <!-- Badge de nivel -->
                <circle
                    *ngIf="punto.visitado"
                    cx="20"
                    cy="-20"
                    r="12"
                    [attr.fill]="obtenerColorNivel(punto.nivelDescubrimiento)"
                    stroke="#ffffff"
                    stroke-width="2"/>

                <text
                    *ngIf="punto.visitado"
                    x="20"
                    y="-15"
                    text-anchor="middle"
                    font-size="14"
                    font-weight="bold"
                    fill="#ffffff">
                    {{ punto.nivelDescubrimiento === NivelDescubrimiento.BRONCE ? 'B' :
                    punto.nivelDescubrimiento === NivelDescubrimiento.PLATA ? 'P' : 'O' }}
                </text>

                <!-- Candado para puntos bloqueados -->
                <text
                    *ngIf="!punto.desbloqueado"
                    text-anchor="middle"
                    dy="8"
                    font-size="20">
                    üîí
                </text>
            </g>
        </svg>
    </div>

    <!-- Leyenda -->
    <div class="leyenda">
        <p-card>
            <div class="leyenda-items">
                <div class="leyenda-item">
                    <span class="icono-leyenda" style="background: #CD7F32;"></span>
                    <span>Bronce - Primera visita</span>
                </div>
                <div class="leyenda-item">
                    <span class="icono-leyenda" style="background: #C0C0C0;"></span>
                    <span>Plata - Segunda visita</span>
                </div>
                <div class="leyenda-item">
                    <span class="icono-leyenda" style="background: #FFD700;"></span>
                    <span>Oro - Exploraci√≥n completa</span>
                </div>
                <div class="leyenda-item">
                    <span class="icono-leyenda bloqueado"></span>
                    <span>üîí Bloqueado</span>
                </div>
            </div>
        </p-card>
    </div>

    <!-- Modal de detalle del punto -->
    <p-dialog
        [(visible)]="mostrarDetalle"
        [modal]="true"
        [style]="{width: '70vw', maxWidth: '900px'}"
        [closable]="true"
        (onHide)="cerrarDetalle()">

        <ng-template pTemplate="header">
            <div class="dialog-header">
                <h2>{{ puntoSeleccionado?.nombre }}</h2>
                <span class="nombre-kichwa">{{ puntoSeleccionado?.nombreKichwa }}</span>
            </div>
        </ng-template>

        <div *ngIf="puntoSeleccionado" class="punto-detalle">
            <!-- Imagen del punto -->
            <div class="imagen-container">
                <img [src]="puntoSeleccionado.imagenUrl" [alt]="puntoSeleccionado.nombre">
                <div class="badge-nivel" [style.background]="obtenerColorNivel(puntoSeleccionado.nivelDescubrimiento)">
                    {{ puntoSeleccionado.nivelDescubrimiento === NivelDescubrimiento.NO_VISITADO ? 'Nueva Exploraci√≥n' :
                    puntoSeleccionado.nivelDescubrimiento === NivelDescubrimiento.BRONCE ? 'Nivel Bronce' :
                        puntoSeleccionado.nivelDescubrimiento === NivelDescubrimiento.PLATA ? 'Nivel Plata' : 'Nivel Oro' }}
                </div>
            </div>

            <!-- Narrativa generada -->
            <div class="narrativa-container">
                <div *ngIf="cargandoNarrativa" class="loading-narrativa">
                    <i class="pi pi-spin pi-spinner" style="font-size: 2rem;"></i>
                    <p>Generando narrativa con IA...</p>
                </div>

                <div *ngIf="!cargandoNarrativa" class="narrativa-texto" (click)="saltarAnimacion()">
                    <p>{{ narrativaVisible }}</p>
                    <small *ngIf="narrativaVisible !== narrativaActual" class="hint">
                        <i class="pi pi-forward"></i> Click para mostrar todo
                    </small>
                </div>
            </div>
        </div>

        <!-- mapa-ingapirca.component.html -->

        <ng-template pTemplate="footer">
            <div class="dialog-footer">
                <!-- ‚úÖ Modo Exploraci√≥n: Cerrar + Completar -->
                <ng-container *ngIf="!modoVisita">
                    <p-button
                        label="Cerrar"
                        icon="pi pi-times"
                        severity="secondary"
                        (onClick)="cerrarDetalle()">
                    </p-button>
                    <p-button
                        *ngIf="!cargandoNarrativa && narrativaCompleta"
                        label="Completar Visita"
                        icon="pi pi-check"
                        (onClick)="completarVisita()">
                    </p-button>
                </ng-container>

                <!-- ‚úÖ Modo Misi√≥n: Solo Confirmar Visita -->
                <ng-container *ngIf="modoVisita">
                    <p-button
                        *ngIf="!cargandoNarrativa && narrativaCompleta"
                        label="Confirmar Visita"
                        icon="pi pi-check-circle"
                        styleClass="w-full"
                        size="large"
                        (onClick)="completarVisita()">
                    </p-button>
                </ng-container>
            </div>
        </ng-template>
    </p-dialog>
</div>
