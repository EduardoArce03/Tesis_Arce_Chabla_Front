<!-- mapa-ingapirca.component.html - FLUJO COMPLETO CON CAPAS -->

<div class="exploracion-container">
    <!-- Header con progreso -->
    <div class="header-exploracion">
        <p-card>
            <div class="flex justify-content-between align-items-center">
                <div>
                    <h2>ExploraciÃ³n de Ingapirca</h2>
                    <p class="subtitle">Descubre los secretos del complejo arqueolÃ³gico CaÃ±ari-Inca</p>
                </div>
                <div class="progreso-info">
                    <span class="puntos-visitados">
                        {{ puntosVisitados() }} / {{ puntos.length }} puntos visitados
                    </span>
                    <p-progressBar
                        [value]="porcentajeVisitados()"
                        [showValue]="false">
                    </p-progressBar>
                </div>
            </div>
        </p-card>
    </div>

    <!-- Mapa SVG -->
    <div class="mapa-container">
        <svg viewBox="0 0 1000 700" class="mapa-svg" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <pattern id="terreno" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
                    <rect width="100" height="100" fill="#e8dcc4"/>
                    <circle cx="10" cy="10" r="2" fill="#d4c4a8" opacity="0.3"/>
                    <circle cx="50" cy="50" r="2" fill="#d4c4a8" opacity="0.3"/>
                </pattern>
            </defs>

            <rect width="1000" height="700" fill="url(#terreno)"/>

            <path d="M 300,400 Q 500,300 700,500" stroke="#8B4513" stroke-width="3" fill="none" stroke-dasharray="10,5" opacity="0.3"/>
            <path d="M 350,550 Q 450,450 650,300" stroke="#8B4513" stroke-width="3" fill="none" stroke-dasharray="10,5" opacity="0.3"/>

            <!-- Puntos de interÃ©s -->
            @for (punto of puntos; track punto.id) {
                <g
                    [attr.transform]="'translate(' + (punto.coordenadaX * 10) + ',' + (punto.coordenadaY * 10) + ')'"
                    class="punto-interes"
                    [class.desbloqueado]="punto.desbloqueado"
                    [class.visitado]="punto.visitado"
                    (click)="seleccionarPunto(punto)"
                    [pTooltip]="punto.nombre"
                    tooltipPosition="top">

                    @if (punto.desbloqueado && !punto.visitado) {
                        <circle r="35" fill="#CD7F32" opacity="0.2" class="glow-pulse"/>
                    }

                    <circle
                        r="25"
                        [attr.fill]="punto.desbloqueado ? '#8B4513' : '#cccccc'"
                        [attr.stroke]="punto.visitado ? '#FFD700' : '#8B4513'"
                        stroke-width="3"/>

                    <text text-anchor="middle" dy="8" font-size="24" [attr.fill]="punto.desbloqueado ? '#ffffff' : '#666666'">
                        {{ obtenerEmojiCategoria(punto.categoria) }}
                    </text>

                    @if (punto.visitado) {
                        <g>
                            <circle cx="20" cy="-20" r="12" fill="#FFD700" stroke="#fff" stroke-width="2"/>
                            <text x="20" y="-15" text-anchor="middle" font-size="14" font-weight="bold" fill="#fff">V</text>
                        </g>
                    }

                    @if (!punto.desbloqueado) {
                        <text text-anchor="middle" dy="8" font-size="20">ðŸ”’</text>
                    }
                </g>
            }
        </svg>
    </div>

    <!-- Leyenda -->
    <div class="leyenda">
        <p-card>
            <div class="leyenda-items">
                <div class="leyenda-item">
                    <span class="icono-leyenda" style="background: #CD7F32;"></span>
                    <span>Bronce</span>
                </div>
                <div class="leyenda-item">
                    <span class="icono-leyenda" style="background: #C0C0C0;"></span>
                    <span>Plata</span>
                </div>
                <div class="leyenda-item">
                    <span class="icono-leyenda" style="background: #FFD700;"></span>
                    <span>Oro</span>
                </div>
            </div>
        </p-card>
    </div>

    <!-- ========================================
         MODAL 1: CAPAS DEL PUNTO (NUEVO)
         ======================================== -->
    <p-dialog
        [(visible)]="mostrarModalCapas"
        [modal]="true"
        [style]="{width: '90vw', maxWidth: '1000px'}"
        [closable]="true"
        (onHide)="cerrarModalCapas()">

        <ng-template pTemplate="header">
            @if (puntoSeleccionado) {
                <div class="dialog-header">
                    <h2>{{ puntoSeleccionado.nombre }}</h2>
                    @if (puntoSeleccionado.nombreKichwa) {
                        <span class="nombre-kichwa">{{ puntoSeleccionado.nombreKichwa }}</span>
                    }
                </div>
            }
        </ng-template>

        @if (puntoSeleccionado) {
            <!-- Usar componente de capas -->
            <app-capas-punto
                [nombrePunto]="puntoSeleccionado.nombre"
                [capas]="capasPunto"
                (explorarCapa)="abrirExploracionCapa($event)"
                (volver)="cerrarModalCapas()">
            </app-capas-punto>
        }
    </p-dialog>

    <!-- ========================================
         MODAL 2: EXPLORACIÃ“N DE CAPA (NUEVO)
         ======================================== -->
    <p-dialog
        [(visible)]="mostrarModalExploracion"
        [modal]="true"
        [style]="{width: '90vw', maxWidth: '1200px', height: '85vh'}"
        [closable]="true"
        (onHide)="cerrarModalExploracion()">

        <ng-template pTemplate="header">
            @if (capaActiva) {
                <div class="exploracion-header">
                    <div>
                        <h2>{{ puntoSeleccionado?.nombre }}</h2>
                        <span class="badge-capa">
                            {{ obtenerIconoCapa(capaActiva.nivelCapa) }} {{ capaActiva.nombre }}
                        </span>
                    </div>
                    <div class="progreso-capa">
                        <span>{{ capaActiva.porcentajeCompletitud }}% completado</span>
                        <p-progressBar [value]="capaActiva.porcentajeCompletitud" [showValue]="false"></p-progressBar>
                    </div>
                </div>
            }
        </ng-template>

        @if (capaActiva) {
            <div class="exploracion-content">
                <!-- NavegaciÃ³n de Tabs -->
                <div class="tabs-navegacion">
                    <button class="tab-button" [class.active]="tabActivo === 0" (click)="cambiarTab(0)">
                        ðŸ“– Narrativa
                        @if (capaActiva.narrativaLeida) {
                            <i class="pi pi-check-circle ml-2"></i>
                        }
                    </button>
                    <button class="tab-button" [class.active]="tabActivo === 1" (click)="cambiarTab(1)">
                        ðŸ“¸ FotografÃ­a
                        <span class="badge-tab">{{ capaActiva.fotografiasCompletadas }}/{{ capaActiva.fotografiasRequeridas }}</span>
                    </button>
                    <button class="tab-button" [class.active]="tabActivo === 2" (click)="cambiarTab(2)">
                        ðŸ’¬ DiÃ¡logo
                        <span class="badge-tab">{{ capaActiva.dialogosRealizados }}</span>
                    </button>
                    <button class="tab-button" [class.active]="tabActivo === 3" (click)="cambiarTab(3)">
                        ðŸŽ¯ MisiÃ³n
                        @if (capaActiva.misionAsociada?.estado) {
                            <i class="pi pi-flag-fill ml-2"></i>
                        }
                    </button>
                </div>

                <!-- Contenido de Tabs -->
                <div class="tab-content">
                    <!-- TAB 1: NARRATIVA -->
                    @if (tabActivo === 0) {
                        <div class="narrativa-panel">
                            <div class="imagen-punto">
                                <img
                                    [src]="puntoSeleccionado?.imagenUrl"
                                    [alt]="puntoSeleccionado?.nombre"
                                    (error)="onImageError($event)">
                            </div>

                            @if (cargandoNarrativa) {
                                <div class="loading-narrativa">
                                    <i class="pi pi-spin pi-spinner" style="font-size: 2rem;"></i>
                                    <p>Generando narrativa con IA...</p>
                                </div>
                            } @else {
                                <div class="narrativa-texto" (click)="saltarAnimacion()">
                                    <p>{{ narrativaVisible }}</p>
                                    @if (narrativaVisible !== narrativaActual) {
                                        <small class="hint"><i class="pi pi-forward"></i> Click para mostrar todo</small>
                                    }
                                </div>
                            }

                            @if (narrativaCompleta && !capaActiva.narrativaLeida) {
                                <div class="narrativa-completada">
                                    <i class="pi pi-check-circle"></i>
                                    <p>Â¡Narrativa completada! Nivel Bronce alcanzado</p>
                                </div>
                            }
                        </div>
                    }

                    <!-- TAB 2: FOTOGRAFÃA -->
                    @if (tabActivo === 1) {
                        <div class="fotografia-panel">
                            <h3>Objetivos FotogrÃ¡ficos</h3>
                            <p class="subtitle">Captura {{ capaActiva.fotografiasRequeridas }} fotografÃ­as para completar esta actividad</p>

                            <div class="objetivos-grid">
                                @for (foto of capaActiva.fotografiasPendientes; track foto.id) {
                                    <div class="objetivo-card" [class.completada]="foto.completada">
                                        <div class="objetivo-header">
                                            <i class="pi" [ngClass]="foto.completada ? 'pi-check-circle' : 'pi-camera'"></i>
                                            <span class="rareza-badge" [class]="'rareza-' + foto.rareza.toLowerCase()">
                                                {{ foto.rareza }}
                                            </span>
                                        </div>
                                        <p>{{ foto.descripcion }}</p>
                                        <small>+{{ foto.descripcion }} puntos</small>

                                        @if (!foto.completada) {
                                            <p-button label="Tomar Foto" icon="pi pi-camera" size="small" class="mt-2"></p-button>
                                            <p-fileUpload
                                                mode="basic"
                                                name="fotografia"
                                                accept="image/*"
                                                [maxFileSize]="5000000"
                                                [auto]="true"
                                                chooseLabel="ðŸ“· Subir Foto"
                                                chooseIcon="pi pi-upload"
                                                (onSelect)="subirFotografia($event, objetivo)"
                                                [customUpload]="true"
                                                (uploadHandler)="procesarFotografia($event, objetivo)">
                                            </p-fileUpload>
                                        } @else {
                                            <span class="completado-badge">âœ“ Completada</span>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- TAB 3: DIÃLOGO -->
                    @if (tabActivo === 2) {
                        <div class="dialogo-panel">
                            <div class="espiritu-avatar">
                                <span class="espiritu-icono">ðŸ‘»</span>
                                <h3>{{ capaActiva.fotografiasRequeridas }}</h3>
                                <p class="espiritu-nombre-kichwa">{{ capaActiva.nombre }}</p>
                            </div>

                            <div class="dialogo-stats">
                                <p>DiÃ¡logos realizados: <strong>{{ capaActiva.dialogosRealizados }}/{{ capaActiva.dialogosRealizados }}</strong></p>
                            </div>

                            <div class="dialogo-input">
                                <textarea
                                    [(ngModel)]="preguntaDialogo"
                                    placeholder="PregÃºntale al espÃ­ritu sobre este lugar, su historia, su cultura..."
                                    rows="3">
                                </textarea>
                                <p-button
                                    label="Preguntar"
                                    icon="pi pi-send"
                                    (onClick)="enviarPregunta()"
                                    [disabled]="!preguntaDialogo?.trim()">
                                </p-button>
                            </div>
                        </div>
                    }

                    <!-- TAB 4: MISIÃ“N -->
                    @if (tabActivo === 3) {
                        <div class="mision-panel">
                            @if (capaActiva.misionAsociada) {
                                <div class="mision-card">
                                    <h3>{{ capaActiva.misionAsociada.titulo }}</h3>
                                    <p>{{ capaActiva.misionAsociada.descripcion }}</p>
                                    <p-progressBar [value]="capaActiva.misionAsociada.progreso" [showValue]="true"></p-progressBar>
                                </div>
                            } @else {
                                <div class="sin-mision">
                                    <i class="pi pi-info-circle"></i>
                                    <p>No hay misiones asociadas a esta capa temporal</p>
                                </div>
                            }
                        </div>
                    }
                </div>
            </div>
        }

        <ng-template pTemplate="footer">
            <div class="footer-exploracion">
                <p-button label="Volver a Capas" icon="pi pi-arrow-left" severity="secondary" (onClick)="volverACapas()"></p-button>
                <p-button label="Salir" icon="pi pi-times" (onClick)="cerrarModalExploracion()"></p-button>
            </div>
        </ng-template>
    </p-dialog>

    <p-toast />
</div>
