<!-- mapa-ingapirca.component.html - ADAPTADO -->

<div class="exploracion-container">
    <!-- Header con progreso -->
    <div class="header-exploracion">
        <p-card>
            <div class="flex justify-content-between align-items-center">
                <div>
                    <h2>Exploraci√≥n de Ingapirca</h2>
                    <p class="subtitle">Descubre los secretos del complejo arqueol√≥gico Ca√±ari-Inca</p>
                </div>
                @if (mapa) {
                    <div class="progreso-info">
                        <span class="puntos-visitados">
                            {{ puntosVisitados() }} / {{ mapa.puntos.length }} puntos visitados
                        </span>
                        <p-progressBar
                            [value]="porcentajeVisitados()"
                            [showValue]="false">
                        </p-progressBar>
                        <div class="stats-extra mt-2">
                            <span>üì∏ {{ mapa.fotografiasCapturadas }} fotos</span>
                            <span>üí¨ {{ mapa.dialogosRealizados }} di√°logos</span>
                            <span>üèÜ {{ mapa.puntuacionTotal }} puntos</span>
                        </div>
                    </div>
                }
            </div>
        </p-card>
    </div>

    <!-- Mapa SVG -->
    @if (mapa) {
        <div class="mapa-container">
            <svg viewBox="0 0 1000 700" class="mapa-svg">
                <defs>
                    <pattern id="terreno" x="0" y="0" width="100" height="100" patternUnits="userSpaceOnUse">
                        <rect width="100" height="100" fill="#e8dcc4"/>
                        <circle cx="10" cy="10" r="2" fill="#d4c4a8" opacity="0.3"/>
                        <circle cx="50" cy="50" r="2" fill="#d4c4a8" opacity="0.3"/>
                    </pattern>

                    <radialGradient id="glowBronce">
                        <stop offset="0%" stop-color="#CD7F32" stop-opacity="0.4"/>
                        <stop offset="100%" stop-color="#CD7F32" stop-opacity="0"/>
                    </radialGradient>
                </defs>

                <rect width="1000" height="700" fill="url(#terreno)"/>

                <!-- Caminos -->
                @for (camino of caminosSVG; track $index) {
                    <path
                        [attr.d]="camino"
                        stroke="#8B4513"
                        stroke-width="2.5"
                        fill="none"
                        stroke-dasharray="10,5"
                        opacity="0.25"
                        stroke-linecap="round"
                        class="camino-punto"/>
                }

                <!-- Puntos -->
                @for (punto of mapa.puntos; track punto.id) {
                    @let coords = mapearCoordenadasVisuales(punto);

                    <g class="punto-interes"
                       [class.explorado]="punto.explorado"
                       (click)="seleccionarPunto(punto)"
                       [pTooltip]="punto.nombre"
                       tooltipPosition="top">

                        <!-- Glow effect -->
                        @if (!punto.explorado) {
                            <circle
                                [attr.cx]="coords.x * 10"
                                [attr.cy]="coords.y * 10"
                                r="35"
                                fill="url(#glowBronce)"
                                class="glow-pulse"
                                pointer-events="none"/>
                        }

                        <!-- C√≠rculo principal -->
                        <circle
                            [attr.cx]="coords.x * 10"
                            [attr.cy]="coords.y * 10"
                            r="25"
                            fill="#8B4513"
                            [attr.stroke]="punto.explorado ? '#FFD700' : '#8B4513'"
                            stroke-width="3"
                            class="punto-circulo"/>

                        <!-- Icono -->
                        <text
                            [attr.x]="coords.x * 10"
                            [attr.y]="coords.y * 10 + 8"
                            text-anchor="middle"
                            font-size="24"
                            fill="#ffffff"
                            pointer-events="none">
                            üèõÔ∏è
                        </text>

                        <!-- Badge visitado -->
                        @if (punto.explorado) {
                            <g pointer-events="none">
                                <circle
                                    [attr.cx]="coords.x * 10 + 20"
                                    [attr.cy]="coords.y * 10 - 20"
                                    r="12"
                                    fill="#FFD700"
                                    stroke="#fff"
                                    stroke-width="2"/>
                                <text
                                    [attr.x]="coords.x * 10 + 20"
                                    [attr.y]="coords.y * 10 - 15"
                                    text-anchor="middle"
                                    font-size="14"
                                    font-weight="bold"
                                    fill="#fff">‚úì</text>
                            </g>
                        }
                    </g>
                }
            </svg>
        </div>
    }

    <!-- MODAL 1: CAPAS DEL PUNTO -->
    <p-dialog
        [(visible)]="mostrarModalCapas"
        [modal]="true"
        [style]="{width: '90vw', maxWidth: '800px'}"
        [closable]="true"
        (onHide)="cerrarModalCapas()">

        <ng-template pTemplate="header">
            @if (puntoSeleccionado) {
                <div class="dialog-header">
                    <h2>{{ puntoSeleccionado.nombre }}</h2>
                    <p>{{ puntoSeleccionado.descripcion }}</p>
                </div>
            }
        </ng-template>

        @if (puntoSeleccionado) {
            <div class="capas-grid">
                @for (capa of puntoSeleccionado.capas; track capa.id) {
                    <div class="capa-card"
                         [class.desbloqueada]="capa.desbloqueada"
                         [class.completada]="capa.completada"
                         (click)="abrirExploracionCapa(capa)">

                        <div class="capa-header">
                            <span class="capa-icono">{{ obtenerIconoCapa(capa.nivel) }}</span>
                            <h3>{{ capa.nombre }}</h3>
                            @if (!capa.desbloqueada) {
                                <span class="badge-bloqueado">üîí Bloqueada</span>
                            }
                        </div>

                        <div class="capa-progreso">
                            <p-progressBar [value]="capa.porcentaje" [showValue]="false"></p-progressBar>
                            <span>{{ capa.porcentaje.toFixed(0) }}% completado</span>
                        </div>

                        <div class="capa-stats">
                            <div class="stat-item">
                                <i class="pi pi-book"></i>
                                <span [class.completado]="capa.narrativaLeida">Narrativa</span>
                            </div>
                            <div class="stat-item">
                                <i class="pi pi-camera"></i>
                                <span>{{ capa.fotografiasCompletadas }}/{{ capa.fotografiasRequeridas }}</span>
                            </div>
                            <div class="stat-item">
                                <i class="pi pi-comments"></i>
                                <span>{{ capa.dialogosRealizados }}</span>
                            </div>
                        </div>

                        @if (capa.desbloqueada && !capa.completada) {
                            <p-button
                                label="Explorar"
                                icon="pi pi-arrow-right"
                                styleClass="w-full"
                                [loading]="cargandoExploracion"
                                [disabled]="cargandoExploracion"
                                (onClick)="abrirExploracionCapa(capa)">
                            </p-button>
                        }

                        @if (capa.completada) {
                            <span class="badge-completada">‚úì Completada</span>
                        }
                    </div>
                }
            </div>
        }
    </p-dialog>

    <!-- MODAL 2: EXPLORACI√ìN DE CAPA -->
    <p-dialog
        [(visible)]="mostrarModalExploracion"
        [modal]="true"
        [style]="{width: '90vw', maxWidth: '1200px', height: '85vh'}"
        [closable]="true"
        (onHide)="cerrarModalExploracion()">

        <ng-template pTemplate="header">
            @if (capaActiva) {
                <div class="exploracion-header">
                    <div>
                        <h2>{{ puntoSeleccionado?.nombre }}</h2>
                        <span class="badge-capa">
                            {{ obtenerIconoCapa(capaActiva.nivel) }} {{ capaActiva.nombre }}
                        </span>
                    </div>
                    <div class="progreso-capa">
                        <span>{{ capaActiva.porcentaje.toFixed(0) }}% completado</span>
                        <p-progressBar [value]="capaActiva.porcentaje" [showValue]="false"></p-progressBar>
                    </div>
                </div>
            }
        </ng-template>

        @if (capaActiva) {
            <div class="exploracion-content">
                <!-- Tabs -->
                <div class="tabs-navegacion">
                    <button class="tab-button" [class.active]="tabActivo === 0" (click)="cambiarTab(0)">
                        üìñ Narrativa
                        @if (capaActiva.narrativaLeida) {
                            <i class="pi pi-check-circle ml-2"></i>
                        }
                    </button>
                    <button class="tab-button" [class.active]="tabActivo === 1" (click)="cambiarTab(1)">
                        üì∏ Fotograf√≠a
                        <span class="badge-tab">{{ capaActiva.fotografiasCompletadas }}/{{ capaActiva.fotografiasRequeridas }}</span>
                    </button>
                    <button class="tab-button" [class.active]="tabActivo === 2" (click)="cambiarTab(2)">
                        üí¨ Di√°logo
                        <span class="badge-tab">{{ capaActiva.dialogosRealizados }}</span>
                    </button>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- TAB 1: NARRATIVA -->
                    @if (tabActivo === 0) {
                        <div class="narrativa-panel">
                            <div class="imagen-punto">
                                <img
                                    [src]="puntoSeleccionado?.imagenUrl"
                                    [alt]="puntoSeleccionado?.nombre"
                                    (error)="onImageError($event)">
                            </div>

                            @if (cargandoNarrativa) {
                                <div class="loading-narrativa">
                                    <i class="pi pi-spin pi-spinner" style="font-size: 2rem;"></i>
                                    <p>Generando narrativa...</p>
                                </div>
                            } @else if (narrativaActual) {
                                <div class="narrativa-texto" (click)="saltarAnimacion()">
                                    <h3>{{ narrativaActual.titulo }}</h3>
                                    <p>{{ narrativaVisible }}</p>
                                    @if (!narrativaCompleta) {
                                        <small class="hint"><i class="pi pi-forward"></i> Click para mostrar todo</small>
                                    }
                                </div>
                            }
                        </div>
                    }

                    <!-- TAB 2: FOTOGRAF√çA -->
                    @if (tabActivo === 1) {
                        <div class="fotografia-panel">
                            <h3>Objetivos Fotogr√°ficos</h3>
                            <p class="subtitle">Captura {{ capaActiva.fotografiasRequeridas }} fotograf√≠as para completar</p>

                            <div class="objetivos-grid">
                                @for (foto of objetivosFotograficos; track foto.id) {
                                    <div class="objetivo-card" [class.completada]="foto.completada">
                                        <div class="objetivo-header">
                                            <i class="pi" [ngClass]="foto.completada ? 'pi-check-circle' : 'pi-camera'"></i>
                                        </div>
                                        <p>{{ foto.descripcion }}</p>

                                        @if (!foto.completada) {
                                            <p-fileUpload
                                                mode="basic"
                                                name="fotografia"
                                                accept="image/*"
                                                [maxFileSize]="5000000"
                                                [auto]="true"
                                                chooseLabel="üì∑ Subir Foto"
                                                [customUpload]="true"
                                                (uploadHandler)="procesarFotografia($event, foto)">
                                            </p-fileUpload>

                                            <p-button
                                                label="Marcar Manual"
                                                icon="pi pi-check"
                                                severity="secondary"
                                                [outlined]="true"
                                                size="small"
                                                styleClass="w-full mt-2"
                                                (onClick)="marcarCompletadoManual(foto)">
                                            </p-button>
                                        } @else {
                                            <span class="completado-badge">‚úì Completada</span>
                                        }
                                    </div>
                                }
                            </div>
                        </div>
                    }

                    <!-- TAB 3: DI√ÅLOGO -->
                    @if (tabActivo === 2) {
                        <div class="dialogo-panel">
                            @if (narrativaActual) {
                                <div class="espiritu-avatar">
                                    <span class="espiritu-icono">{{ obtenerIconoCapa(capaActiva.nivel) }}</span>
                                    <h3>{{ narrativaActual.nombreEspiritu }}</h3>
                                </div>
                            }

                            <div class="dialogo-stats">
                                <p>Di√°logos realizados: <strong>{{ capaActiva.dialogosRealizados }}</strong></p>
                            </div>

                            <div class="dialogo-input">
                                <label for="pregunta-espiritu">
                                    <i class="pi pi-comments"></i> Preg√∫ntale al esp√≠ritu ancestral
                                </label>
                                <textarea
                                    id="pregunta-espiritu"
                                    [(ngModel)]="preguntaDialogo"
                                    placeholder="Pregunta sobre este lugar sagrado..."
                                    rows="4"
                                    [disabled]="cargandoRespuesta">
                                </textarea>

                                <p-button
                                    label="Consultar al Esp√≠ritu"
                                    icon="pi pi-send"
                                    (onClick)="enviarPregunta()"
                                    [disabled]="!preguntaDialogo?.trim() || cargandoRespuesta"
                                    [loading]="cargandoRespuesta"
                                    styleClass="w-full">
                                </p-button>
                            </div>
                        </div>
                    }
                </div>
            </div>
        }

        <ng-template pTemplate="footer">
            <div class="footer-exploracion">
                <p-button label="Volver a Capas" icon="pi pi-arrow-left" severity="secondary" (onClick)="volverACapas()"></p-button>
                <p-button label="Salir" icon="pi pi-times" (onClick)="cerrarModalExploracion()"></p-button>
            </div>
        </ng-template>
    </p-dialog>

    <!-- MODAL: RESPUESTA ESP√çRITU -->
    <p-dialog
        [(visible)]="mostrarRespuestaEspiritu"
        [modal]="true"
        [style]="{width: '90vw', maxWidth: '700px'}"
        [closable]="true"
        styleClass="dialogo-espiritu"
        (onHide)="cerrarRespuestaEspiritu()">

        <ng-template pTemplate="header">
            <div class="dialogo-espiritu-header">
                <div class="espiritu-avatar-modal">
                    <span class="espiritu-icono-grande">{{ obtenerIconoCapa(capaActiva?.nivel) }}</span>
                </div>
                <div>
                    <h2>{{ nombreEspirituActual }}</h2>
                    <p class="espiritu-subtitulo">Esp√≠ritu Ancestral</p>
                </div>
            </div>
        </ng-template>

        <div class="dialogo-espiritu-content">
            <div class="pregunta-usuario">
                <div class="pregunta-label">
                    <i class="pi pi-user"></i>
                    <span>Tu pregunta:</span>
                </div>
                <p>"{{ preguntaActual }}"</p>
            </div>

            <div class="respuesta-espiritu" (click)="saltarAnimacionEspiritu()">
                <div class="respuesta-label">
                    <i class="pi pi-star"></i>
                    <span>Respuesta del esp√≠ritu:</span>
                </div>

                @if (cargandoRespuesta) {
                    <div class="loading-respuesta">
                        <i class="pi pi-spin pi-spinner" style="font-size: 2rem;"></i>
                        <p>El esp√≠ritu est√° meditando...</p>
                    </div>
                } @else {
                    <p class="texto-respuesta">{{ respuestaEspirituVisible }}</p>

                    @if (!respuestaCompletaEspiritu) {
                        <small class="hint-click">
                            <i class="pi pi-hand-pointer"></i> Click para mostrar todo
                        </small>
                    }
                }
            </div>
        </div>

        <ng-template pTemplate="footer">
            <p-button
                label="Entendido"
                icon="pi pi-check"
                (onClick)="cerrarRespuestaEspiritu()"
                styleClass="w-full">
            </p-button>
        </ng-template>
    </p-dialog>

    <p-toast />
    <p-dialog
        [(visible)]="mostrarResultadoFoto"
        [modal]="true"
        [style]="{width: '90vw', maxWidth: '700px'}"
        [closable]="true"
        styleClass="resultado-foto-dialog"
        (onHide)="cerrarResultadoFoto()">

        <ng-template pTemplate="header">
            <div class="resultado-foto-header">
                @if (resultadoFotoAnalisis?.exito) {
                    <div class="header-exito">
                        <span class="icon-grande">‚úÖ</span>
                        <div>
                            <h2>¬°Fotograf√≠a Aceptada!</h2>
                            <p class="subtitulo-header">El an√°lisis IA ha validado tu captura</p>
                        </div>
                    </div>
                } @else {
                    <div class="header-rechazo">
                        <span class="icon-grande">‚ùå</span>
                        <div>
                            <h2>Fotograf√≠a Rechazada</h2>
                            <p class="subtitulo-header">La imagen no cumple con el objetivo</p>
                        </div>
                    </div>
                }
            </div>
        </ng-template>

        @if (resultadoFotoAnalisis) {
            <div class="resultado-foto-content">
                <!-- Imagen capturada -->
                <div class="foto-preview">
                    <img
                        [src]="'data:image/jpeg;base64,' + resultadoFotoAnalisis.imagenBase64"
                        alt="Fotograf√≠a capturada"
                        class="foto-capturada">

                    @if (resultadoFotoAnalisis.exito) {
                        <div class="badge-aprobada">
                            <i class="pi pi-check"></i>
                            APROBADA
                        </div>
                    }
                </div>

                <!-- Objetivo -->
                <div class="objetivo-info">
                    <h3>üì∏ Objetivo Fotogr√°fico</h3>
                    <p class="objetivo-descripcion">{{ resultadoFotoAnalisis.objetivo.descripcion }}</p>
                </div>

                <!-- An√°lisis IA -->
                <div class="analisis-ia-card" [class.exito]="resultadoFotoAnalisis.exito">
                    <div class="analisis-header">
                        <i class="pi pi-sparkles"></i>
                        <h3>An√°lisis de Inteligencia Artificial</h3>
                    </div>

                    <div class="analisis-descripcion">
                        <p>{{ resultadoFotoAnalisis.descripcionIA }}</p>
                    </div>

                    <!-- Barra de confianza -->
                    @if (resultadoFotoAnalisis.exito) {
                        <div class="confianza-section">
                            <div class="confianza-label">
                                <span>Nivel de Confianza</span>
                                <span class="confianza-porcentaje">{{ obtenerPorcentajeConfianza().toFixed(0) }}%</span>
                            </div>
                            <div class="confianza-barra">
                                <div
                                    class="confianza-progreso"
                                    [style.width.%]="obtenerPorcentajeConfianza()"
                                    [style.background]="obtenerColorConfianza()">
                                </div>
                            </div>
                        </div>
                    }
                </div>

                <!-- Recompensa -->
                @if (resultadoFotoAnalisis.exito) {
                    <div class="recompensa-card">
                        <div class="recompensa-icono">üéÅ</div>
                        <div class="recompensa-info">
                            <h3>Recompensa Obtenida</h3>
                            <div class="puntos-ganados">
                                <span class="puntos-numero">+{{ resultadoFotoAnalisis.puntos }}</span>
                                <span class="puntos-texto">puntos</span>
                            </div>
                        </div>
                    </div>

                    <!-- Progreso -->
                    <div class="progreso-fotos">
                        <div class="progreso-label">
                            <i class="pi pi-camera"></i>
                            <span>Progreso de Fotograf√≠as</span>
                        </div>
                        <div class="progreso-stats">
                        <span class="progreso-numeros">
                            {{ resultadoFotoAnalisis.fotografiasCompletadas }} / {{ resultadoFotoAnalisis.fotografiasRequeridas }}
                        </span>
                            <p-progressBar
                                [value]="(resultadoFotoAnalisis.fotografiasCompletadas / resultadoFotoAnalisis.fotografiasRequeridas) * 100"
                                [showValue]="false">
                            </p-progressBar>
                        </div>
                    </div>
                } @else {
                    <!-- Sugerencias para mejorar -->
                    <div class="sugerencias-card">
                        <div class="sugerencias-header">
                            <i class="pi pi-lightbulb"></i>
                            <h3>Sugerencias para Mejorar</h3>
                        </div>
                        <ul class="sugerencias-lista">
                            <li><i class="pi pi-arrow-right"></i> Intenta capturar desde un mejor √°ngulo</li>
                            <li><i class="pi pi-arrow-right"></i> Aseg√∫rate de que el objetivo est√© bien iluminado</li>
                            <li><i class="pi pi-arrow-right"></i> Ac√©rcate m√°s al elemento que deseas fotografiar</li>
                            <li><i class="pi pi-arrow-right"></i> Verifica que el objetivo est√© completo en la imagen</li>
                        </ul>
                    </div>
                }
            </div>
        }

        <ng-template pTemplate="footer">
            <div class="footer-resultado-foto">
                @if (resultadoFotoAnalisis?.exito) {
                    <p-button
                        label="¬°Continuar Explorando!"
                        icon="pi pi-check-circle"
                        (onClick)="cerrarResultadoFoto()"
                        styleClass="w-full p-button-lg">
                    </p-button>
                } @else {
                    <p-button
                        label="Intentar de Nuevo"
                        icon="pi pi-refresh"
                        severity="warn"
                        (onClick)="cerrarResultadoFoto()"
                        styleClass="w-full p-button-lg">
                    </p-button>
                }
            </div>
        </ng-template>
    </p-dialog>
</div>
