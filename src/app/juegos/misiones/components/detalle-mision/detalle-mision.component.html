<div class="detalle-mision-container">
    <p-toast></p-toast>

    <!-- Loading -->
    <div class="loading-container" *ngIf="cargando">
        <p-card>
            <div class="loading-content">
                <i class="pi pi-spin pi-spinner" style="font-size: 3rem;"></i>
                <p>Cargando misi√≥n...</p>
            </div>
        </p-card>
    </div>

    <!-- Contenido Principal -->
    <div class="contenido-detalle" *ngIf="!cargando && detalle">
        <!-- Header -->
        <div class="header-detalle">
            <p-card>
                <div class="header-content">
                    <!-- Imagen de Portada -->
                    <div class="portada">
                        <img [src]="detalle.mision.imagenPortada" [alt]="detalle.mision.titulo" onerror="this.src='/assets/misiones/default.jpg'">
                        <div class="portada-overlay">
                            <p-tag
                                [value]="detalle.mision.dificultad"
                                [severity]="obtenerColorDificultad(detalle.mision.dificultad)"
                                styleClass="dificultad-tag">
                            </p-tag>
                        </div>
                    </div>

                    <!-- Info Principal -->
                    <div class="info-principal">
                        <h1>{{ detalle.mision.titulo }}</h1>
                        <p class="titulo-kichwa">{{ detalle.mision.tituloKichwa }}</p>
                        <p class="descripcion-corta">{{ detalle.mision.descripcionCorta }}</p>

                        <div class="meta-info">
                            <div class="meta-item">
                                <i class="pi pi-clock"></i>
                                <span>~{{ detalle.mision.tiempoEstimado }} min</span>
                            </div>
                            <div class="meta-item">
                                <i class="pi pi-star"></i>
                                <span>{{ obtenerIconoDificultad(detalle.mision.dificultad) }}</span>
                            </div>
                            <div class="meta-item">
                                <i class="pi pi-list"></i>
                                <span>{{ detalle.fases.length }} fases</span>
                            </div>
                        </div>

                        <!-- Progreso (si est√° en progreso) -->
                        <div class="progreso-actual" *ngIf="detalle.progreso">
                            <h3>Tu Progreso</h3>
                            <div class="progreso-stats">
                                <div class="stat">
                                    <span class="label">Fase:</span>
                                    <span class="valor">{{ detalle.progreso.faseActual + 1 }}/{{ detalle.fases.length }}</span>
                                </div>
                                <div class="stat">
                                    <span class="label">Puntuaci√≥n:</span>
                                    <span class="valor">{{ detalle.progreso.puntuacion }} pts</span>
                                </div>
                            </div>
                            <p-progressbar [value]="detalle.progreso.porcentajeCompletado"></p-progressbar>
                        </div>

                        <!-- Botones de Acci√≥n -->
                        <div class="acciones-principales">
                            <p-button
                                *ngIf="detalle.puedeIniciar && !detalle.progreso"
                                label="Iniciar Misi√≥n"
                                icon="pi pi-play"
                                size="large"
                                (onClick)="iniciarMision()">
                            </p-button>

                            <p-button
                                *ngIf="detalle.progreso"
                                label="Continuar Misi√≥n"
                                icon="pi pi-arrow-right"
                                size="large"
                                (onClick)="continuarMision()">
                            </p-button>

                            <p-button
                                *ngIf="!detalle.puedeIniciar"
                                [label]="detalle.motivoBloqueo || 'Bloqueada'"
                                icon="pi pi-lock"
                                size="large"
                                [disabled]="true"
                                severity="secondary">
                            </p-button>

                            <p-button
                                label="Volver"
                                icon="pi pi-arrow-left"
                                size="large"
                                severity="secondary"
                                [outlined]="true"
                                routerLink="/juegos/misiones">
                            </p-button>
                        </div>
                    </div>
                </div>
            </p-card>
        </div>

        <!-- Descripci√≥n Detallada -->
        <div class="seccion-descripcion">
            <p-card header="üìñ Historia de la Misi√≥n">
                <p class="descripcion-larga">{{ detalle.mision.descripcionLarga }}</p>
            </p-card>
        </div>

        <div class="grid mt-4">
            <!-- Columna Izquierda -->
            <div class="col-12 lg:col-8">
                <!-- NPC Gu√≠a -->
                <p-card header="Tu Gu√≠a Espiritual" styleClass="mb-3">
                    <div class="npc-info">
                        <img [src]="detalle.mision.npcGuia.avatar" [alt]="detalle.mision.npcGuia.nombre" class="npc-avatar">
                        <div class="npc-texto">
                            <h3>{{ detalle.mision.npcGuia.nombre }}</h3>
                            <p class="npc-nombre-kichwa">{{ detalle.mision.npcGuia.nombreKichwa }}</p>
                            <p class="npc-dialogo">"{{ detalle.mision.npcDialogoInicial }}"</p>
                        </div>
                    </div>
                </p-card>

                <!-- Fases de la Misi√≥n -->
                <p-card header="üó∫Ô∏è Fases de la Misi√≥n">
                    <div class="fases-lista">
                        <div *ngFor="let fase of detalle.fases; let i = index"
                             class="fase-item"
                             [class.fase-completada]="fase.completada">

                            <div class="fase-numero">
                                <i *ngIf="!fase.completada" class="pi pi-circle"></i>
                                <i *ngIf="fase.completada" class="pi pi-check-circle"></i>
                                <span>{{ i + 1 }}</span>
                            </div>

                            <div class="fase-info">
                                <h4>{{ fase.titulo }}</h4>
                                <p>{{ fase.descripcion }}</p>
                                <div class="fase-meta">
                                    <span class="tipo-fase">{{ fase.tipoFase }}</span>
                                    <span class="exp-fase">+{{ fase.experienciaFase }} XP</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </p-card>
            </div>

            <!-- Columna Derecha -->
            <div class="col-12 lg:col-4">
                <!-- Recompensas -->
                <p-card header="üéÅ Recompensas" styleClass="mb-3">
                    <div class="recompensas-detalle">
                        <div class="recompensa-item">
                            <i class="pi pi-bolt text-yellow-500"></i>
                            <span>{{ detalle.mision.recompensas.experiencia }} XP</span>
                        </div>
                        <div class="recompensa-item">
                            <i class="pi pi-star text-blue-500"></i>
                            <span>{{ detalle.mision.recompensas.puntos }} Puntos</span>
                        </div>

                        <p-divider></p-divider>

                        <div class="insignias-recompensa">
                            <p class="insignias-titulo">Insignias:</p>
                            <div *ngFor="let insignia of detalle.mision.recompensas.insignias"
                                 class="insignia-preview">
                                <span class="insignia-icono">{{ insignia.icono }}</span>
                                <div class="insignia-info">
                                    <p class="insignia-nombre">{{ insignia.nombre }}</p>
                                    <p class="insignia-desc">{{ insignia.nombreKichwa }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </p-card>

                <!-- Requisitos -->
                <p-card header="üìã Requisitos">
                    <div class="requisitos-detalle">
                        <div class="requisito-item">
                            <i class="pi pi-user"></i>
                            <span>Nivel {{ detalle.mision.requisitos.nivelMinimo }} de Arque√≥logo</span>
                        </div>

                        <div class="requisito-item" *ngIf="detalle.mision.requisitos.misionesPrevias && detalle.mision.requisitos.misionesPrevias.length > 0">
                            <i class="pi pi-check-square"></i>
                            <span>{{ detalle.mision.requisitos.misionesPrevias.length }} misiones previas</span>
                        </div>

                        <div class="requisito-item" *ngIf="detalle.mision.requisitos.insignias && detalle.mision.requisitos.insignias.length > 0">
                            <i class="pi pi-shield"></i>
                            <span>{{ detalle.mision.requisitos.insignias.length }} insignias requeridas</span>
                        </div>
                    </div>
                </p-card>
            </div>
        </div>
    </div>
</div>
