<div class="misiones-container">
    <p-toast></p-toast>

    <!-- Header con Estad铆sticas -->
    <div class="header-misiones">
        <p-card>
            <div class="header-content">
                <div class="header-info">
                    <h1> Misiones Culturales</h1>
                    <p class="subtitle">Descubre los secretos de Ingapirca a trav茅s de misiones guiadas</p>
                </div>

                <div class="estadisticas" *ngIf="estadisticas">
                    <div class="stat-card">
                        <span class="stat-value">{{ estadisticas.completadas }}</span>
                        <span class="stat-label">Completadas</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value">{{ estadisticas.insigniasObtenidas }}</span>
                        <span class="stat-label">Insignias</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-value">{{ estadisticas.porcentajeCompletado | number:'1.0-0' }}%</span>
                        <span class="stat-label">Progreso</span>
                    </div>
                </div>
            </div>

            <p-progressbar
                [value]="estadisticas?.porcentajeCompletado || 0"
                [showValue]="false"
                styleClass="mt-3">
            </p-progressbar>
        </p-card>
    </div>

    <!-- Loading State -->
    <div class="loading-container" *ngIf="cargando">
        <p-card>
            <div class="loading-content">
                <i class="pi pi-spin pi-spinner" style="font-size: 3rem;"></i>
                <p>Cargando misiones...</p>
            </div>
        </p-card>
    </div>

    <!-- Tabs de Misiones -->
    <div class="contenido-misiones" *ngIf="!cargando">
        <p-tabs value="0">
            <p-tablist>
                <p-tab value="0">
                    <i class="pi pi-play-circle mr-2"></i>
                    Disponibles ({{ misionesDisponibles.length }})
                </p-tab>
                <p-tab value="1">
                    <i class="pi pi-spinner mr-2"></i>
                    En Progreso ({{ misionesEnProgreso.length }})
                </p-tab>
                <p-tab value="2">
                    <i class="pi pi-check mr-2"></i>
                    Completadas ({{ misionesCompletadas.length }})
                </p-tab>
                <p-tab value="3">
                    <i class="pi pi-lock mr-2"></i>
                    Bloqueadas ({{ misionesBloqueadas.length }})
                </p-tab>
            </p-tablist>

            <p-tabpanels>
                <!-- DISPONIBLES -->
                <p-tabpanel value="0">
                    <div class="misiones-grid" *ngIf="misionesDisponibles.length > 0; else sinDisponibles">
                        <div *ngFor="let mision of misionesDisponibles" class="mision-card-wrapper">
                            <p-card styleClass="mision-card disponible">
                                <!-- Imagen de portada -->
                                <div class="mision-imagen">
                                    <img [src]="mision.imagenPortada" [alt]="mision.titulo" onerror="this.src='/assets/misiones/default.jpg'">
                                    <div class="overlay-info">
                                        <p-tag
                                            [value]="mision.dificultad"
                                            [severity]="obtenerColorDificultad(mision.dificultad)">
                                        </p-tag>
                                    </div>
                                </div>

                                <!-- Contenido -->
                                <div class="mision-contenido">
                                    <!-- NPC Gu铆a -->
                                    <div class="npc-info">
                                        <p-avatar
                                            [image]="mision.npcGuia.avatar"
                                            size="large"
                                            shape="circle"
                                            [style]="{'width': '60px', 'height': '60px'}">
                                        </p-avatar>
                                        <div class="npc-texto">
                                            <span class="npc-nombre">{{ mision.npcGuia.nombre }}</span>
                                            <span class="npc-titulo">{{ mision.npcGuia.nombreKichwa }}</span>
                                        </div>
                                    </div>

                                    <!-- T铆tulo -->
                                    <h3 class="mision-titulo">{{ mision.titulo }}</h3>
                                    <p class="mision-titulo-kichwa">{{ mision.tituloKichwa }}</p>

                                    <!-- Descripci贸n -->
                                    <p class="mision-descripcion">{{ mision.descripcionCorta }}</p>

                                    <!-- Info Adicional -->
                                    <div class="mision-meta">
                                        <div class="meta-item">
                                            <i class="pi pi-clock"></i>
                                            <span>~{{ mision.tiempoEstimado }} min</span>
                                        </div>
                                        <div class="meta-item">
                                            <i class="pi pi-star"></i>
                                            <span>{{ obtenerIconoDificultad(mision.dificultad) }}</span>
                                        </div>
                                        <div class="meta-item">
                                            <i class="pi pi-gift"></i>
                                            <span>+{{ mision.recompensas.experiencia }} XP</span>
                                        </div>
                                    </div>

                                    <!-- Acciones -->
                                    <div class="mision-acciones">
                                        <p-button
                                            label="Ver Detalles"
                                            icon="pi pi-eye"
                                            [outlined]="true"
                                            (onClick)="verDetalleMision(mision)">
                                        </p-button>
                                        <p-button
                                            label="Iniciar Misi贸n"
                                            icon="pi pi-play"
                                            (onClick)="verDetalleMision(mision)">
                                        </p-button>
                                    </div>
                                </div>
                            </p-card>
                        </div>
                    </div>

                    <ng-template #sinDisponibles>
                        <div class="mensaje-vacio">
                            <i class="pi pi-check-circle" style="font-size: 3rem; color: #22c55e;"></i>
                            <h3>隆Has completado todas las misiones disponibles!</h3>
                            <p>Completa misiones bloqueadas para desbloquear nuevas aventuras</p>
                        </div>
                    </ng-template>
                </p-tabpanel>

                <!-- EN PROGRESO -->
                <p-tabpanel value="1">
                    <div class="misiones-grid" *ngIf="misionesEnProgreso.length > 0; else sinProgreso">
                        <div *ngFor="let mision of misionesEnProgreso" class="mision-card-wrapper">
                            <p-card styleClass="mision-card en-progreso">
                                <div class="mision-imagen">
                                    <img [src]="mision.imagenPortada" [alt]="mision.titulo" onerror="this.src='/assets/misiones/default.jpg'">
                                    <div class="overlay-badge">
                                        <span class="badge-progreso">En Progreso</span>
                                    </div>
                                </div>

                                <div class="mision-contenido">
                                    <div class="npc-info">
                                        <p-avatar [image]="mision.npcGuia.avatar" size="large" shape="circle"></p-avatar>
                                        <div class="npc-texto">
                                            <span class="npc-nombre">{{ mision.npcGuia.nombre }}</span>
                                        </div>
                                    </div>

                                    <h3 class="mision-titulo">{{ mision.titulo }}</h3>

                                    <!-- Progreso -->
                                    <div class="progreso-info" *ngIf="mision.progreso">
                                        <div class="flex justify-content-between mb-2">
                                            <span>Fase {{ mision.progreso.faseActual }} / {{ mision.progreso.totalFases }}</span>
                                            <span>{{ calcularProgreso(mision) | number:'1.0-0' }}%</span>
                                        </div>
                                        <p-progressbar [value]="calcularProgreso(mision)"></p-progressbar>
                                    </div>

                                    <div class="mision-stats" *ngIf="mision.progreso">
                                        <div class="stat-small">
                                            <i class="pi pi-check text-green-500"></i>
                                            <span>{{ mision.progreso.respuestasCorrectas }} correctas</span>
                                        </div>
                                        <div class="stat-small">
                                            <i class="pi pi-star-fill text-yellow-500"></i>
                                            <span>{{ mision.progreso.puntuacion }} pts</span>
                                        </div>
                                    </div>

                                    <div class="mision-acciones">
                                        <p-button
                                            label="Continuar"
                                            icon="pi pi-arrow-right"
                                            (onClick)="continuarMision(mision)">
                                        </p-button>
                                    </div>
                                </div>
                            </p-card>
                        </div>
                    </div>

                    <ng-template #sinProgreso>
                        <div class="mensaje-vacio">
                            <i class="pi pi-inbox" style="font-size: 3rem; color: #94a3b8;"></i>
                            <h3>No tienes misiones en progreso</h3>
                            <p>Inicia una nueva misi贸n desde la pesta帽a "Disponibles"</p>
                        </div>
                    </ng-template>
                </p-tabpanel>

                <!-- COMPLETADAS -->
                <p-tabpanel value="2">
                    <div class="misiones-grid" *ngIf="misionesCompletadas.length > 0; else sinCompletadas">
                        <div *ngFor="let mision of misionesCompletadas" class="mision-card-wrapper">
                            <p-card styleClass="mision-card completada">
                                <div class="mision-imagen">
                                    <img [src]="mision.imagenPortada" [alt]="mision.titulo" onerror="this.src='/assets/misiones/default.jpg'">
                                    <div class="overlay-completada">
                                        <i class="pi pi-check-circle"></i>
                                        <span>Completada</span>
                                    </div>
                                </div>

                                <div class="mision-contenido">
                                    <h3 class="mision-titulo">{{ mision.titulo }}</h3>

                                    <!-- Insignias obtenidas -->
                                    <div class="insignias-obtenidas" *ngIf="mision.recompensas.insignias.length > 0">
                                        <div *ngFor="let insignia of mision.recompensas.insignias"
                                             class="insignia-mini"
                                             [pTooltip]="insignia.nombre">
                                            <span class="insignia-icono">{{ insignia.icono }}</span>
                                        </div>
                                    </div>

                                    <div class="mision-stats-final" *ngIf="mision.progreso">
                                        <div class="stat-small">
                                            <span class="label">Puntuaci贸n:</span>
                                            <span class="valor">{{ mision.progreso.puntuacion }}</span>
                                        </div>
                                        <div class="stat-small">
                                            <span class="label">Precisi贸n:</span>
                                            <span class="valor">
                                                {{ (mision.progreso.respuestasCorrectas / mision.progreso.intentos * 100) | number:'1.0-0' }}%
                                            </span>
                                        </div>
                                    </div>

                                    <div class="mision-acciones">
                                        <p-button
                                            label="Ver Detalles"
                                            icon="pi pi-eye"
                                            severity="secondary"
                                            [outlined]="true"
                                            (onClick)="verDetalleMision(mision)">
                                        </p-button>
                                    </div>
                                </div>
                            </p-card>
                        </div>
                    </div>

                    <ng-template #sinCompletadas>
                        <div class="mensaje-vacio">
                            <i class="pi pi-trophy" style="font-size: 3rem; color: #94a3b8;"></i>
                            <h3>A煤n no has completado ninguna misi贸n</h3>
                            <p>隆Completa tu primera misi贸n para ganar insignias y experiencia!</p>
                        </div>
                    </ng-template>
                </p-tabpanel>

                <!-- BLOQUEADAS -->
                <p-tabpanel value="3">
                    <div class="misiones-grid" *ngIf="misionesBloqueadas.length > 0">
                        <div *ngFor="let mision of misionesBloqueadas" class="mision-card-wrapper">
                            <p-card styleClass="mision-card bloqueada">
                                <div class="mision-imagen bloqueada-overlay">
                                    <img [src]="mision.imagenPortada" [alt]="mision.titulo" onerror="this.src='/assets/misiones/default.jpg'">
                                    <div class="overlay-lock">
                                        <i class="pi pi-lock"></i>
                                    </div>
                                </div>

                                <div class="mision-contenido">
                                    <h3 class="mision-titulo">{{ mision.titulo }}</h3>
                                    <p class="mision-descripcion">{{ mision.descripcionCorta }}</p>

                                    <!-- Requisitos -->
                                    <div class="requisitos-bloqueo">
                                        <p class="requisitos-titulo">
                                            <i class="pi pi-info-circle"></i>
                                            Requisitos:
                                        </p>
                                        <ul class="requisitos-lista">
                                            <li *ngIf="mision.requisitos.nivelMinimo > 1">
                                                Nivel m铆nimo: {{ mision.requisitos.nivelMinimo }}
                                            </li>
                                            <li *ngIf="mision.requisitos.misionesPrevias && mision.requisitos.misionesPrevias.length > 0">
                                                Completar {{ mision.requisitos.misionesPrevias.length }} misiones previas
                                            </li>
                                            <li *ngIf="mision.requisitos.insignias && mision.requisitos.insignias.length > 0">
                                                Obtener {{ mision.requisitos.insignias.length }} insignias espec铆ficas
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                            </p-card>
                        </div>
                    </div>
                </p-tabpanel>
            </p-tabpanels>
        </p-tabs>
    </div>
</div>
