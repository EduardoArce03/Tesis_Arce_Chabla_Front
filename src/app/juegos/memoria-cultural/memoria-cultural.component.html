<!-- src/app/components/memoria-cultural/memoria-cultural.component.html -->
<div class="memoria-game-container">

    <!-- ==================== PANEL DE CONFIGURACI√ìN ==================== -->
    <div class="config-panel" *ngIf="!juegoIniciado && !cargandoJuego">
        <p-card styleClass="config-card">
            <ng-template pTemplate="header">
                <div class="card-header">
                    <div class="header-icon">üéÆ</div>
                    <h2>Juego de Memoria Cultural</h2>
                    <p>Aprende sobre la cultura Ca√±ari e Inca mientras juegas</p>
                </div>
            </ng-template>

            <div class="config-content">
                <div class="field">
                    <label for="nivel">
                        <i class="pi pi-sliders-h"></i>
                        Nivel de Dificultad
                    </label>
                    <p-select
                        id="nivel"
                        [options]="nivelesDisponibles"
                        [(ngModel)]="nivelSeleccionado"
                        optionLabel="label"
                        optionValue="value"
                        placeholder="Selecciona un nivel"
                        [style]="{'width':'100%'}">
                    </p-select>
                </div>

                <div class="field">
                    <label for="categoria">
                        <i class="pi pi-th-large"></i>
                        Categor√≠a Cultural
                    </label>
                    <p-selectButton
                        id="categoria"
                        [options]="categoriasDisponibles"
                        [(ngModel)]="categoriaSeleccionada"
                        optionLabel="label"
                        optionValue="value">
                    </p-selectButton>
                </div>

                <div class="field">
                    <p-button
                        label="Iniciar Juego"
                        icon="pi pi-play"
                        (onClick)="iniciarJuego()"
                        [style]="{'width':'100%'}"
                        styleClass="p-button-lg start-button">
                    </p-button>
                </div>
            </div>
        </p-card>
    </div>

    <!-- ==================== PANTALLA DE CARGA ==================== -->
    <div class="loading-screen" *ngIf="cargandoJuego">
        <div class="loading-content">
            <div class="loading-icon">
                <div class="chakana-loader">‚ú¶</div>
            </div>
            <h2 class="loading-title">Preparando tu juego...</h2>
            <p class="loading-subtitle">Cargando elementos culturales</p>
            <div class="loading-bar">
                <div class="loading-progress"></div>
            </div>
            <div class="loading-facts">
                <p class="fact-text">üí° Los Ca√±aris habitaron el sur del Ecuador</p>
            </div>
        </div>
    </div>

    <!-- ==================== PANEL DE JUEGO ==================== -->
    <div class="game-panel" *ngIf="juegoIniciado && !juegoTerminado && !cargandoJuego">

        <!-- HUD Superior con Gamificaci√≥n -->
        <div class="game-header">
            <p-card styleClass="hud-card">
                <div class="hud-container">
                    <!-- Columna Izquierda: Vidas y Stats -->
                    <div class="hud-left">
                        <!-- Sistema de Vidas -->
                        <div class="vidas-container">
                            <span class="vidas-label">
                                <i class="pi pi-heart-fill"></i>
                                Vidas:
                            </span>
                            <div class="vidas-hearts">
                                <i *ngFor="let vida of vidasArray"
                                   class="pi"
                                   [ngClass]="vida ? 'pi-heart-fill vida-llena' : 'pi-heart vida-vacia'">
                                </i>
                            </div>
                        </div>

                        <!-- Stats b√°sicas -->
                        <div class="game-stats">
                            <div class="stat-item">
                                <i class="pi pi-clock"></i>
                                <span>{{ tiempoTranscurrido }}s</span>
                            </div>
                            <div class="stat-item">
                                <i class="pi pi-sync"></i>
                                <span>{{ intentos }} intentos</span>
                            </div>
                            <div class="stat-item">
                                <i class="pi pi-check-circle"></i>
                                <span>{{ parejasEncontradas }} / {{ tarjetas.length / 2 }}</span>
                            </div>
                        </div>
                    </div>

                    <!-- Columna Centro: Combo Meter -->
                    <div class="hud-center" *ngIf="estadoPartida?.combo?.comboActivo">
                        <div class="combo-display" [ngClass]="animacionCombo">
                            <div class="combo-icon">{{ obtenerIconoCombo() }}</div>
                            <div class="combo-text">
                                <span class="combo-label">{{ obtenerTextoCombo() }}</span>
                                <span class="combo-mult">x{{ estadoPartida.combo.multiplicador }}</span>
                            </div>
                            <div class="combo-counter">{{ estadoPartida.combo.parejasConsecutivas }} seguidas</div>
                        </div>
                    </div>

                    <!-- Columna Derecha: Hints y Controles -->
                    <div class="hud-right">
                        <!-- Bot√≥n de Hint -->
                        <p-button
                            icon="pi pi-lightbulb"
                            [label]="'Pista (' + estadoPartida?.hints?.usosRestantes + ')'"
                            [badge]="estadoPartida?.hints?.costo?.toString()"
                            (onClick)="solicitarHint()"
                            [disabled]="!estadoPartida || estadoPartida.hints?.usosRestantes === 0"
                            severity="info"
                            [outlined]="true"
                            styleClass="hint-button">
                        </p-button>

                        <!-- Bot√≥n Reiniciar -->
                        <p-button
                            icon="pi pi-refresh"
                            label="Reiniciar"
                            (onClick)="reiniciarJuego()"
                            severity="secondary"
                            [outlined]="true">
                        </p-button>
                    </div>
                </div>
            </p-card>
        </div>

        <!-- Tablero de Juego -->
        <div class="game-board" [ngClass]="getGridClass()">
            <div *ngFor="let tarjeta of tarjetas"
                 class="memory-card"
                 [ngClass]="{
                   'flipped': tarjeta.volteada,
                   'matched': tarjeta.emparejada
                 }"
                 (click)="voltearTarjeta(tarjeta)">

                <div class="card-inner">
                    <div class="card-back">
                        <div class="back-pattern">
                            <div class="chakana">‚ú¶</div>
                            <div class="pattern-dots"></div>
                        </div>
                    </div>

                    <div class="card-front">
                        <div class="card-image">
                            <img [src]="tarjeta.imagen" [alt]="tarjeta.nombreEspanol">
                        </div>
                        <div class="card-label">
                            <p class="kichwa-name">{{ tarjeta.nombreKichwa }}</p>
                            <p class="spanish-name">{{ tarjeta.nombreEspanol }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Animaci√≥n de Combo Flotante -->
        <div class="combo-animation" *ngIf="mostrarCombo" [ngClass]="animacionCombo">
            <div class="combo-burst">{{ obtenerIconoCombo() }}</div>
            <div class="combo-title">{{ obtenerTextoCombo() }}</div>
            <div class="combo-multiplier">x{{ estadoPartida?.combo?.multiplicador }}</div>
        </div>
    </div>

    <!-- ==================== DI√ÅLOGOS (igual que antes) ==================== -->
    <p-dialog
        [(visible)]="mostrarNarrativaEducativa"
        [modal]="true"
        [closable]="false"
        [style]="{width: '550px'}"
        header="üíî Momento de Aprendizaje"
        styleClass="narrativa-dialog">
        <div class="narrativa-content" *ngIf="narrativaActual">
            <div class="narrativa-header">
                <img [src]="elementoActual?.imagen"
                     [alt]="narrativaActual.nombreEspanol"
                     class="narrativa-imagen">
                <div class="narrativa-titulo">
                    <h3>{{ narrativaActual.titulo }}</h3>
                    <p class="kichwa-subtitle">{{ narrativaActual.nombreKichwa }}</p>
                </div>
            </div>
            <p-divider></p-divider>
            <div class="narrativa-descripcion">
                <p>{{ narrativaActual.descripcion }}</p>
            </div>
            <div class="narrativa-stats">
                <span class="stat-warning">
                    <i class="pi pi-exclamation-triangle"></i>
                    Te quedan {{ estadoPartida?.vidas?.vidasActuales }} vidas
                </span>
            </div>
        </div>
        <ng-template pTemplate="footer">
            <p-button
                label="Continuar"
                icon="pi pi-arrow-right"
                (onClick)="cerrarNarrativa()"
                styleClass="p-button-lg">
            </p-button>
        </ng-template>
    </p-dialog>

    <p-dialog
        [(visible)]="mostrarPregunta"
        [modal]="true"
        [closable]="false"
        [style]="{width: '500px'}"
        header="‚ù§Ô∏è Recupera 1 Vida"
        styleClass="pregunta-dialog">
        <div class="pregunta-content" *ngIf="narrativaActual?.preguntaRecuperacion">
            <div class="pregunta-texto">
                <p>{{ narrativaActual?.preguntaRecuperacion?.pregunta }}</p>
            </div>
            <div class="pregunta-opciones">
                <p-button
                    *ngFor="let opcion of narrativaActual?.preguntaRecuperacion?.opciones; let i = index"
                    [label]="opcion"
                    (onClick)="responderPregunta(i)"
                    [outlined]="true"
                    [style]="{'width':'100%', 'margin-bottom': '0.5rem'}"
                    styleClass="p-button-lg opcion-button">
                </p-button>
            </div>
            <div class="pregunta-info">
                <small>
                    <i class="pi pi-info-circle"></i>
                    Responde correctamente para recuperar 1 vida
                </small>
            </div>
        </div>
    </p-dialog>

    <p-dialog
        [(visible)]="mostrarDialogoHint"
        [modal]="true"
        [style]="{width: '450px'}"
        header="üí° Pista Cultural"
        styleClass="hint-dialog">
        <div class="hint-content">
            <div class="hint-icon">
                <i class="pi pi-lightbulb"></i>
            </div>
            <p class="hint-mensaje">{{ hintMensaje }}</p>
            <div class="hint-costo">
                <i class="pi pi-minus-circle"></i>
                <span>-{{ estadoPartida?.hints?.costo }} puntos</span>
            </div>
        </div>
        <ng-template pTemplate="footer">
            <p-button
                label="Entendido"
                icon="pi pi-check"
                (onClick)="cerrarDialogoHint()">
            </p-button>
        </ng-template>
    </p-dialog>

    <p-dialog
        [(visible)]="juegoTerminado"
        [modal]="true"
        [closable]="false"
        [style]="{width: '600px'}"
        header="üéâ ¬°Allillachu! (¬°Muy bien!)"
        styleClass="victoria-dialog">
        <div class="resultados-content">
            <div class="puntuacion-final">
                <div class="trophy-icon">üèÜ</div>
                <h3>{{ puntuacionFinal }} puntos</h3>
            </div>
            <p-divider></p-divider>
            <div class="estadisticas-finales">
                <div class="estadistica">
                    <i class="pi pi-clock"></i>
                    <span class="label">Tiempo</span>
                    <span class="valor">{{ estadisticasFinales?.tiempoTotal || tiempoTranscurrido }}s</span>
                </div>
                <div class="estadistica">
                    <i class="pi pi-sync"></i>
                    <span class="label">Intentos</span>
                    <span class="valor">{{ intentos }}</span>
                </div>
                <div class="estadistica">
                    <i class="pi pi-percentage"></i>
                    <span class="label">Precisi√≥n</span>
                    <span class="valor">{{ calcularPrecision() }}%</span>
                </div>
            </div>
            <div class="estadisticas-gamificacion" *ngIf="estadisticasFinales">
                <div class="stat-game">
                    <i class="pi pi-heart-fill"></i>
                    <span>{{ estadisticasFinales.vidasRestantes }} vidas restantes</span>
                </div>
                <div class="stat-game">
                    <i class="pi pi-bolt"></i>
                    <span>Mejor combo: {{ estadisticasFinales.mejorCombo }}</span>
                </div>
                <div class="stat-game">
                    <i class="pi pi-lightbulb"></i>
                    <span>{{ estadisticasFinales.hintsUsados }} pistas usadas</span>
                </div>
                <div class="stat-game">
                    <i class="pi pi-eye"></i>
                    <span>{{ estadisticasFinales.nuevosDescubrimientos }} descubrimientos</span>
                </div>
            </div>
            <p-divider></p-divider>
            <div *ngIf="insigniasNuevas.length > 0" class="insignias-nuevas">
                <h4>üèÜ ¬°Nuevas Insignias Desbloqueadas!</h4>
                <div class="insignias-grid">
                    <div *ngFor="let insignia of insigniasNuevas" class="insignia-item">
                        <div class="insignia-icono">{{ insignia.icono }}</div>
                        <p class="insignia-nombre">{{ insignia.nombre }}</p>
                        <p class="insignia-kichwa">{{ insignia.nombreKichwa }}</p>
                        <small>{{ insignia.descripcion }}</small>
                    </div>
                </div>
            </div>
            <div *ngIf="insigniasNuevas.length === 0" class="sin-insignias">
                <p>üí™ ¬°Sigue jugando para desbloquear insignias!</p>
            </div>
        </div>
        <ng-template pTemplate="footer">
            <p-button
                label="Jugar de nuevo"
                icon="pi pi-refresh"
                (onClick)="reiniciarJuego()"
                styleClass="p-button-lg p-button-success">
            </p-button>
            <p-button
                label="Volver al men√∫"
                icon="pi pi-home"
                severity="secondary"
                (onClick)="volverAlMenu()"
                styleClass="p-button-lg"
                [outlined]="true">
            </p-button>
        </ng-template>
    </p-dialog>

    <p-dialog
        [(visible)]="juegoGameOver"
        [modal]="true"
        [closable]="true"
        [style]="{width: '500px'}"
        header="üíÄ Game Over"
        styleClass="gameover-dialog">
        <div class="gameover-content">
            <div class="gameover-icon">
                <i class="pi pi-times-circle"></i>
            </div>
            <h3>¬°Te has quedado sin vidas!</h3>
            <p-divider></p-divider>
            <div class="gameover-stats">
                <div class="stat-item">
                    <i class="pi pi-check"></i>
                    <span>{{ parejasEncontradas }} parejas encontradas</span>
                </div>
                <div class="stat-item">
                    <i class="pi pi-clock"></i>
                    <span>{{ tiempoTranscurrido }}s jugados</span>
                </div>
                <div class="stat-item">
                    <i class="pi pi-sync"></i>
                    <span>{{ intentos }} intentos realizados</span>
                </div>
            </div>
            <div class="gameover-message">
                <p><strong>¬°No te rindas!</strong></p>
                <p>Cada partida es una oportunidad para aprender m√°s sobre la cultura Ca√±ari.</p>
            </div>
        </div>
        <ng-template pTemplate="footer">
            <p-button
                label="Intentar de nuevo"
                icon="pi pi-refresh"
                (onClick)="reiniciarDespuesGameOver()"
                styleClass="p-button-lg p-button-danger">
            </p-button>
            <p-button
                label="Volver al men√∫"
                icon="pi pi-home"
                severity="secondary"
                (onClick)="volverAlMenu()"
                styleClass="p-button-lg"
                [outlined]="true">
            </p-button>
        </ng-template>
    </p-dialog>
</div>

<p-toast position="top-center"></p-toast>
