<!-- src/app/components/rompe-cabezas/rompe-cabezas.component.html -->

<p-toast></p-toast>

<div class="puzzle-game-container">

    <!-- ==================== DI√ÅLOGO: SELECTOR DE IM√ÅGENES ==================== -->
    <p-dialog
        [(visible)]="mostrarSelectorImagenes"
        [modal]="true"
        [closable]="false"
        [style]="{width: '90vw', maxWidth: '1200px'}"
        header="Selecciona un Rompecabezas"
        styleClass="selector-imagenes-dialog">

        <!-- Barra de progreso del jugador -->
        <div class="progreso-jugador" *ngIf="progreso">
            <div class="stat-item">
                <i class="pi pi-star-fill"></i>
                <span>{{ progreso.estrellasTotal }} Estrellas</span>
            </div>
            <div class="stat-item">
                <i class="pi pi-check-circle"></i>
                <span>{{ progreso.puzzlesCompletados }} Completados</span>
            </div>
            <div class="stat-item">
                <i class="pi pi-clock"></i>
                <span>Mejor: {{ formatTime(progreso.mejorTiempo) }}</span>
            </div>
        </div>

        <!-- Galer√≠a de im√°genes -->
        <div class="imagenes-grid">
            <div
                *ngFor="let imagen of imagenesDisponibles"
                class="imagen-card"
                [class.bloqueada]="!imagen.desbloqueada"
                (click)="seleccionarImagen(imagen)">

                <div class="imagen-wrapper">
                    <!-- Imagen -->
                    <img [src]="imagen.imagenUrl" [alt]="imagen.titulo">

                    <!-- Overlay de bloqueado -->
                    <div class="overlay-bloqueado" *ngIf="!imagen.desbloqueada">
                        <i class="pi pi-lock" style="font-size: 3rem;"></i>
                        <p>Bloqueado</p>
                    </div>

                    <!-- Badge de orden -->
                    <div class="badge-orden">{{ imagen.ordenDesbloqueo }}</div>
                </div>

                <div class="imagen-info">
                    <h3>{{ imagen.titulo }}</h3>
                    <p class="nombre-kichwa">{{ imagen.nombreKichwa }}</p>
                    <div class="dificultad">
                        <i class="pi pi-th-large"></i>
                        <span>{{ imagen.dificultadMinima }}x{{ imagen.dificultadMinima }} - {{ imagen.dificultadMaxima }}x{{ imagen.dificultadMaxima }}</span>
                    </div>
                </div>
            </div>
        </div>
    </p-dialog>

    <!-- ==================== √ÅREA DEL PUZZLE ==================== -->
    <div class="puzzle-area" *ngIf="!mostrarSelectorImagenes">

        <!-- HUD Superior -->
        <div class="puzzle-hud">
            <!-- Izquierda: Info de la imagen -->
            <div class="hud-left">
                <button
                    pButton
                    icon="pi pi-arrow-left"
                    label="Volver"
                    class="p-button-text p-button-sm"
                    (click)="volverAlMenu()">
                </button>
                <div class="imagen-actual-info" *ngIf="imagenActual">
                    <h3>{{ imagenActual.titulo }}</h3>
                    <span class="kichwa">{{ imagenActual.nombreKichwa }}</span>
                </div>
            </div>

            <!-- Centro: Estad√≠sticas -->
            <div class="hud-center">
                <div class="stat">
                    <i class="pi pi-clock"></i>
                    <span>{{ formatTime(tiempoTranscurrido) }}</span>
                </div>
                <div class="stat">
                    <i class="pi pi-sync"></i>
                    <span>{{ moves }} movimientos</span>
                </div>

                <!-- Contador de power-ups -->
                <div class="stat power-ups-counter" *ngIf="isPlaying">
                    <i class="pi pi-bolt"></i>
                    <span>{{ powerUpsDisponibles.length }}/3</span>
                </div>
            </div>

            <!-- Derecha: Controles -->
            <div class="hud-right">
                <!-- Bot√≥n de Power-Ups -->
                <button
                    *ngIf="isPlaying && powerUpsDisponibles.length > 0"
                    pButton
                    icon="pi pi-bolt"
                    label="Power-Ups"
                    class="p-button-warning p-button-sm"
                    badgeClass="p-badge-danger"
                    (click)="abrirMenuPowerUps()">
                </button>

                <button
                    *ngIf="!isPlaying"
                    pButton
                    label="Iniciar"
                    icon="pi pi-play"
                    class="p-button-success"
                    (click)="iniciarJuego()">
                </button>
            </div>
        </div>

        <!-- Banner de Power-Up Activo -->
        <div class="power-up-activo-banner" *ngIf="powerUpActivo">
            <div class="banner-content">
                <i class="pi pi-sun" *ngIf="powerUpActivo === 'BENDICION_SOL'"></i>
                <span>‚òÄÔ∏è Bendici√≥n del Sol activa - x2 puntos</span>
                <span class="tiempo-restante">{{ formatTime(tiempoPowerUpActivo) }}</span>
            </div>
        </div>

        <!-- Selector de dificultad (solo visible antes de iniciar) -->
        <div class="dificultad-selector" *ngIf="!isPlaying && imagenActual">
            <label>Dificultad:</label>
            <div class="size-buttons">
                <button
                    *ngFor="let size of [3, 4, 5, 6]"
                    pButton
                    [label]="size + 'x' + size"
                    [class.p-button-outlined]="gridSize !== size"
                    [disabled]="imagenActual && (size < imagenActual.dificultadMinima || size > imagenActual.dificultadMaxima)"
                    (click)="changeGridSize(size)">
                </button>
            </div>
        </div>

        <!-- Contenedor del puzzle -->
        <div class="puzzle-wrapper">
            <div #puzzleContainer class="puzzle-container"></div>
        </div>
    </div>

    <!-- ==================== DI√ÅLOGO: DESAF√çO CULTURAL ==================== -->
    <p-dialog
        [(visible)]="mostrarDesafio"
        [modal]="true"
        [closable]="false"
        [style]="{width: '600px'}"
        header="üéØ ¬°Desaf√≠o Cultural!"
        styleClass="desafio-dialog">

        <div class="desafio-content" *ngIf="desafioActual">
            <!-- Contador de tiempo -->
            <div class="tiempo-desafio">
                <i class="pi pi-clock"></i>
                <span class="tiempo-numero" [class.urgente]="tiempoDesafio <= 5">
                    {{ tiempoDesafio }}s
                </span>
            </div>

            <!-- Barra de progreso -->
            <p-progressBar
                [value]="(tiempoDesafio / desafioActual.tiempoLimite) * 100"
                [showValue]="false"
                [style]="{height: '8px'}"
                styleClass="tiempo-bar">
            </p-progressBar>

            <!-- Pregunta -->
            <div class="pregunta-container">
                <h3>{{ desafioActual.pregunta }}</h3>
            </div>

            <!-- Opciones -->
            <div class="opciones-container">
                <button
                    *ngFor="let opcion of desafioActual.opciones"
                    pButton
                    [label]="opcion"
                    [class.selected]="respuestaSeleccionada === opcion"
                    [class.correcta]="desafioRespondido && respuestaSeleccionada === opcion"
                    [disabled]="desafioRespondido"
                    class="opcion-btn"
                    (click)="seleccionarRespuesta(opcion)">
                </button>
            </div>

            <!-- Mensaje de resultado -->
            <div class="resultado-mensaje" *ngIf="desafioRespondido">
                <i class="pi pi-check-circle" *ngIf="respuestaSeleccionada"></i>
                <i class="pi pi-times-circle" *ngIf="!respuestaSeleccionada"></i>
            </div>
        </div>

        <ng-template pTemplate="footer">
            <p-button
                *ngIf="!desafioRespondido"
                label="Confirmar"
                icon="pi pi-check"
                [disabled]="!respuestaSeleccionada"
                (onClick)="confirmarRespuesta()"
                styleClass="p-button-success">
            </p-button>
        </ng-template>
    </p-dialog>

    <!-- ==================== DI√ÅLOGO: MEN√ö DE POWER-UPS ==================== -->
    <p-dialog
        [(visible)]="mostrarMenuPowerUps"
        [modal]="true"
        [closable]="true"
        [style]="{width: '700px'}"
        header="‚ö° Power-Ups Disponibles"
        styleClass="powerups-dialog">

        <div class="powerups-content">
            <p class="powerups-info">
                <i class="pi pi-info-circle"></i>
                Selecciona un power-up para activarlo. Puedes tener m√°ximo 3 guardados.
            </p>

            <div class="powerups-grid">
                <div
                    *ngFor="let powerUp of powerUpsDisponibles"
                    class="powerup-card"
                    (click)="usarPowerUp(powerUp)">

                    <div class="powerup-icono">{{ powerUp.icono }}</div>

                    <div class="powerup-info-detail">
                        <h4>{{ powerUp.nombre }}</h4>
                        <p>{{ powerUp.descripcion }}</p>
                    </div>

                    <button
                        pButton
                        icon="pi pi-bolt"
                        label="Usar"
                        class="p-button-sm p-button-warning">
                    </button>
                </div>
            </div>

            <div class="powerups-vacio" *ngIf="powerUpsDisponibles.length === 0">
                <i class="pi pi-inbox"></i>
                <p>No tienes power-ups disponibles</p>
                <small>Responde desaf√≠os correctamente para obtener power-ups</small>
            </div>
        </div>
    </p-dialog>

    <!-- ==================== DI√ÅLOGO: VICTORIA ==================== -->
    <p-dialog
        [(visible)]="mostrarVictoria"
        [modal]="true"
        [closable]="false"
        [style]="{width: '600px'}"
        header="¬°Puzzle Completado!"
        styleClass="victoria-dialog">

        <div class="victoria-content">
            <!-- Estrellas animadas -->
            <div class="estrellas-container">
                <div class="estrellas-display">
                    <span
                        *ngFor="let estrella of obtenerEstrellas(estrellasObtenidas); let i = index"
                        class="estrella-animada"
                        [style.animation-delay]="(i * 0.2) + 's'">
                        {{ estrella }}
                    </span>
                </div>
                <p class="mensaje-estrellas">{{ mensajeVictoria }}</p>
            </div>

            <p-divider></p-divider>

            <!-- Estad√≠sticas -->
            <div class="estadisticas-finales">
                <div class="stat-final">
                    <i class="pi pi-clock"></i>
                    <div>
                        <span class="label">Tiempo</span>
                        <span class="value">{{ formatTime(tiempoTranscurrido) }}</span>
                    </div>
                </div>
                <div class="stat-final">
                    <i class="pi pi-sync"></i>
                    <div>
                        <span class="label">Movimientos</span>
                        <span class="value">{{ moves }}</span>
                    </div>
                </div>
                <div class="stat-final">
                    <i class="pi pi-star-fill"></i>
                    <div>
                        <span class="label">Estrellas Totales</span>
                        <span class="value">{{ progreso?.estrellasTotal || 0 }}</span>
                    </div>
                </div>
            </div>

            <!-- Siguiente imagen desbloqueada -->
            <div class="siguiente-desbloqueado" *ngIf="siguienteImagen">
                <div class="desbloqueo-banner">
                    <i class="pi pi-unlock"></i>
                    <span>¬°Nueva imagen desbloqueada!</span>
                </div>
                <div class="siguiente-preview">
                    <img [src]="siguienteImagen.imagenUrl" [alt]="siguienteImagen.titulo">
                    <div class="siguiente-info">
                        <h4>{{ siguienteImagen.titulo }}</h4>
                        <p>{{ siguienteImagen.nombreKichwa }}</p>
                    </div>
                </div>
            </div>
        </div>

        <ng-template pTemplate="footer">
            <p-button
                *ngIf="siguienteImagen"
                label="Continuar"
                icon="pi pi-arrow-right"
                (onClick)="continuarSiguiente()"
                styleClass="p-button-lg p-button-success">
            </p-button>
            <p-button
                label="Volver al men√∫"
                icon="pi pi-home"
                severity="secondary"
                (onClick)="volverAlMenu()"
                styleClass="p-button-lg">
            </p-button>
        </ng-template>
    </p-dialog>

</div>
