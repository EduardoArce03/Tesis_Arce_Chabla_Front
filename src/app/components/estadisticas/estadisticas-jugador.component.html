<div class="estadisticas-container">
    <!-- Header Mejorado -->
    <div class="estadisticas-header">
        <div class="header-content">
            <div class="header-left">
                <div class="header-icon-wrapper">
                    <i class="pi pi-chart-bar"></i>
                </div>
                <div class="header-text">
                    <h1>Mis Estad√≠sticas</h1>
                    <p>Analiza tu rendimiento y progreso en el juego</p>
                </div>
            </div>
            <p-button
                label="Volver"
                icon="pi pi-arrow-left"
                (onClick)="volverAlDashboard()"
                [outlined]="true"
                styleClass="header-button">
            </p-button>
        </div>
    </div>

    <!-- Loading State -->
    <div class="loading-state" *ngIf="cargando">
        <div class="grid">
            <div class="col-12 md:col-6 lg:col-3" *ngFor="let i of [1,2,3,4]">
                <div class="skeleton-card">
                    <p-skeleton width="100%" height="150px"></p-skeleton>
                </div>
            </div>
        </div>
        <div class="skeleton-card mt-4">
            <p-skeleton width="100%" height="300px"></p-skeleton>
        </div>
    </div>

    <!-- Content -->
    <div class="estadisticas-content" *ngIf="!cargando && estadisticas">

        <!-- Resumen General - Redise√±ado -->
        <div class="stats-grid">
            <!-- Total Partidas -->
            <div class="stat-card-modern total-partidas">
                <div class="stat-card-header">
                    <div class="stat-icon-circle">
                        <i class="pi pi-play-circle"></i>
                    </div>
                    <div class="stat-trend">
                        <span class="trend-icon">üìà</span>
                    </div>
                </div>
                <div class="stat-card-body">
                    <h3 class="stat-title">Total Partidas</h3>
                    <div class="stat-value-wrapper">
                        <span class="stat-value">{{ estadisticas.resumenGeneral.totalPartidas }}</span>
                        <span class="stat-unit">partidas</span>
                    </div>
                    <div class="stat-detail-row">
                        <span class="detail-label">Completadas</span>
                        <span class="detail-value">{{ estadisticas.resumenGeneral.partidasCompletadas }}</span>
                    </div>
                    <div class="progress-container">
                        <p-progressBar
                            [value]="estadisticas.resumenGeneral.tasaCompletacion"
                            [showValue]="false">
                        </p-progressBar>
                        <span class="progress-label">{{ estadisticas.resumenGeneral.tasaCompletacion.toFixed(0) }}% tasa de completaci√≥n</span>
                    </div>
                </div>
            </div>

            <!-- Puntuaci√≥n Total -->
            <div class="stat-card-modern puntos-totales">
                <div class="stat-card-header">
                    <div class="stat-icon-circle">
                        <i class="pi pi-star-fill"></i>
                    </div>
                    <div class="stat-badge best-score-badge" *ngIf="estadisticas.resumenGeneral.mejorPuntuacion">
                        <i class="pi pi-trophy"></i>
                        {{ estadisticas.resumenGeneral.mejorPuntuacion }}
                    </div>
                </div>
                <div class="stat-card-body">
                    <h3 class="stat-title">Puntos Totales</h3>
                    <div class="stat-value-wrapper">
                        <span class="stat-value">{{ estadisticas.resumenGeneral.puntuacionTotal }}</span>
                        <span class="stat-unit">pts</span>
                    </div>
                    <div class="stat-detail-row">
                        <span class="detail-label">Promedio</span>
                        <span class="detail-value">{{ estadisticas.resumenGeneral.puntuacionPromedio.toFixed(0) }} pts</span>
                    </div>
                </div>
            </div>

            <!-- Tiempo Jugado -->
            <div class="stat-card-modern tiempo-jugado">
                <div class="stat-card-header">
                    <div class="stat-icon-circle">
                        <i class="pi pi-clock"></i>
                    </div>
                </div>
                <div class="stat-card-body">
                    <h3 class="stat-title">Tiempo Jugado</h3>
                    <div class="stat-value-wrapper">
                        <span class="stat-value">{{ estadisticas.resumenGeneral.tiempoTotalMinutos }}</span>
                        <span class="stat-unit">min</span>
                    </div>
                    <div class="stat-detail-row">
                        <span class="detail-label">Promedio por partida</span>
                        <span class="detail-value">{{ estadisticas.resumenGeneral.tiempoPromedioMinutos.toFixed(1) }} min</span>
                    </div>
                </div>
            </div>

            <!-- Precisi√≥n -->
            <div class="stat-card-modern precision">
                <div class="stat-card-header">
                    <div class="stat-icon-circle">
                        <i class="pi pi-bullseye"></i>
                    </div>
                    <div class="stat-badge" [ngClass]="estadisticas.resumenGeneral.precisionPromedio >= 80 ? 'success-badge' : 'warning-badge'">
                        {{ estadisticas.resumenGeneral.precisionPromedio >= 80 ? '¬°Excelente!' : 'Mejorando' }}
                    </div>
                </div>
                <div class="stat-card-body">
                    <h3 class="stat-title">Precisi√≥n</h3>
                    <div class="stat-value-wrapper">
                        <span class="stat-value">{{ estadisticas.resumenGeneral.precisionPromedio.toFixed(0) }}</span>
                        <span class="stat-unit">%</span>
                    </div>
                    <div class="precision-chart">
                        <div class="precision-ring" [style.--precision]="estadisticas.resumenGeneral.precisionPromedio">
                            <svg viewBox="0 0 36 36">
                                <path class="circle-bg"
                                      d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                <path class="circle"
                                      [attr.stroke-dasharray]="estadisticas.resumenGeneral.precisionPromedio + ', 100'"
                                      d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Rachas - Redise√±adas -->
        <div class="rachas-container">
            <div class="section-header">
                <h2>
                    <i class="pi pi-bolt"></i>
                    Rachas y Logros
                </h2>
            </div>

            <div class="rachas-grid">
                <div class="racha-card racha-actual">
                    <div class="racha-background">
                        <div class="racha-icon">üî•</div>
                    </div>
                    <div class="racha-content">
                        <span class="racha-label">Racha Actual</span>
                        <span class="racha-value">{{ estadisticas.rachas.rachaActual }}</span>
                        <span class="racha-subtitle">partidas consecutivas</span>
                    </div>
                    <div class="racha-decoration"></div>
                </div>

                <div class="racha-card racha-mejor">
                    <div class="racha-background">
                        <div class="racha-icon">üèÜ</div>
                    </div>
                    <div class="racha-content">
                        <span class="racha-label">Mejor Racha</span>
                        <span class="racha-value">{{ estadisticas.rachas.mejorRacha }}</span>
                        <span class="racha-subtitle">r√©cord personal</span>
                    </div>
                    <div class="racha-decoration"></div>
                </div>

                <div class="racha-card racha-invicto">
                    <div class="racha-background">
                        <div class="racha-icon">‚ö°</div>
                    </div>
                    <div class="racha-content">
                        <span class="racha-label">Racha Invicta</span>
                        <span class="racha-value">{{ estadisticas.rachas.partidasConsecutivasSinPerder }}</span>
                        <span class="racha-subtitle">partidas sin perder</span>
                    </div>
                    <div class="racha-decoration"></div>
                </div>
            </div>
        </div>

        <!-- Gr√°ficos - Mejorados -->
        <div class="charts-section">
            <div class="charts-grid">
                <!-- Gr√°fico Principal -->
                <div class="chart-card chart-main">
                    <div class="chart-header">
                        <div class="chart-title-wrapper">
                            <i class="pi pi-chart-line"></i>
                            <div>
                                <h3>Evoluci√≥n de Puntuaciones</h3>
                                <p>√öltimas 10 partidas jugadas</p>
                            </div>
                        </div>
                    </div>
                    <div class="chart-body">
                        <p-chart
                            type="line"
                            [data]="chartPuntuaciones"
                            [options]="chartOptions"
                            [style]="{'height': '300px'}">
                        </p-chart>
                    </div>
                </div>

                <!-- Gr√°fico por Nivel -->
                <div class="chart-card chart-doughnut">
                    <div class="chart-header">
                        <div class="chart-title-wrapper">
                            <i class="pi pi-chart-pie"></i>
                            <div>
                                <h3>Por Nivel</h3>
                                <p>Distribuci√≥n de partidas</p>
                            </div>
                        </div>
                    </div>
                    <div class="chart-body">
                        <p-chart
                            type="doughnut"
                            [data]="chartPorNivel"
                            [style]="{'height': '300px'}">
                        </p-chart>
                    </div>
                </div>
            </div>

            <!-- Gr√°fico por Categor√≠a -->
            <div class="chart-card chart-full">
                <div class="chart-header">
                    <div class="chart-title-wrapper">
                        <i class="pi pi-chart-bar"></i>
                        <div>
                            <h3>Rendimiento por Categor√≠a</h3>
                            <p>Puntuaci√≥n promedio por tipo de juego</p>
                        </div>
                    </div>
                </div>
                <div class="chart-body">
                    <p-chart
                        type="bar"
                        [data]="chartPorCategoria"
                        [options]="chartOptions"
                        [style]="{'height': '280px'}">
                    </p-chart>
                </div>
            </div>
        </div>

        <!-- Top Partidas - Redise√±ado -->
        <div class="top-partidas-section">
            <div class="section-header">
                <h2>
                    <i class="pi pi-trophy"></i>
                    Top 5 Mejores Partidas
                </h2>
            </div>

            <div class="top-partidas-grid">
                <div class="top-partida-card" *ngFor="let partida of estadisticas.mejoresPartidas; let i = index"
                     [ngClass]="'position-' + (i + 1)">
                    <div class="partida-position">
                        <span class="position-number">{{ i === 0 ? 'ü•á' : i === 1 ? 'ü•à' : i === 2 ? 'ü•â' : '#' + (i + 1) }}</span>
                    </div>
                    <div class="partida-info">
                        <div class="partida-header-row">
                            <p-tag
                                [value]="getNivelLabel(partida.nivel)"
                                [severity]="getNivelSeverity(partida.nivel)">
                            </p-tag>
                            <span class="partida-fecha">{{ formatearFecha(partida.fechaInicio) }}</span>
                        </div>
                        <div class="partida-categoria">{{ getCategoriaLabel(partida.categoria) }}</div>
                        <div class="partida-stats-row">
                            <div class="stat-item">
                                <i class="pi pi-star-fill"></i>
                                <span class="stat-value-large">{{ partida.puntuacion }}</span>
                                <span class="stat-label-small">puntos</span>
                            </div>
                            <div class="stat-divider"></div>
                            <div class="stat-item">
                                <i class="pi pi-clock"></i>
                                <span>{{ formatearTiempo(partida.tiempoSegundos) }}</span>
                            </div>
                            <div class="stat-divider"></div>
                            <div class="stat-item">
                                <i class="pi pi-bullseye"></i>
                                <span>{{ partida.precision.toFixed(0) }}%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- An√°lisis por Nivel - Mejorado -->
        <div class="nivel-analysis-section">
            <div class="section-header">
                <h2>
                    <i class="pi pi-sliders-h"></i>
                    An√°lisis por Nivel de Dificultad
                </h2>
            </div>

            <div class="nivel-cards-grid">
                <div class="nivel-card" *ngFor="let stats of estadisticas.estadisticasPorNivel"
                     [ngClass]="'nivel-' + stats.nivel.toLowerCase()">
                    <div class="nivel-card-header">
                        <div class="nivel-badge-large">
                            <span class="nivel-icon">{{ stats.nivel === 'FACIL' ? 'üü¢' : stats.nivel === 'MEDIO' ? 'üü°' : 'üî¥' }}</span>
                            <span class="nivel-text">{{ getNivelLabel(stats.nivel) }}</span>
                        </div>
                        <p-tag
                            [value]="stats.partidasJugadas + ' partidas'"
                            [severity]="getNivelSeverity(stats.nivel)">
                        </p-tag>
                    </div>

                    <div class="nivel-stats-grid">
                        <div class="nivel-stat-item">
                            <div class="stat-icon-small">‚úì</div>
                            <div class="stat-text">
                                <span class="stat-label">Completadas</span>
                                <span class="stat-value">{{ stats.partidasCompletadas }}</span>
                            </div>
                        </div>

                        <div class="nivel-stat-item">
                            <div class="stat-icon-small">‚≠ê</div>
                            <div class="stat-text">
                                <span class="stat-label">Puntuaci√≥n Promedio</span>
                                <span class="stat-value">{{ stats.puntuacionPromedio.toFixed(0) }}</span>
                            </div>
                        </div>

                        <div class="nivel-stat-item">
                            <div class="stat-icon-small">üèÜ</div>
                            <div class="stat-text">
                                <span class="stat-label">Mejor Puntuaci√≥n</span>
                                <span class="stat-value">{{ stats.mejorPuntuacion || 'N/A' }}</span>
                            </div>
                        </div>

                        <div class="nivel-stat-item">
                            <div class="stat-icon-small">üéØ</div>
                            <div class="stat-text">
                                <span class="stat-label">Precisi√≥n Promedio</span>
                                <span class="stat-value">{{ stats.precisionPromedio.toFixed(0) }}%</span>
                            </div>
                        </div>
                    </div>

                    <div class="nivel-progress-section">
                        <div class="progress-header">
                            <span>Rendimiento</span>
                            <span class="progress-percentage">{{ stats.precisionPromedio.toFixed(0) }}%</span>
                        </div>
                        <p-progressBar
                            [value]="stats.precisionPromedio"
                            [showValue]="false">
                        </p-progressBar>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historial Completo - Tabla Mejorada -->
        <div class="historial-section">
            <div class="section-header">
                <h2>
                    <i class="pi pi-history"></i>
                    Historial de Partidas
                </h2>
            </div>

            <div class="historial-card">
                <p-table
                    [value]="estadisticas.historialPartidas"
                    [paginator]="true"
                    [rows]="10"
                    [tableStyle]="{'min-width': '50rem'}"
                    styleClass="modern-table">
                    <ng-template pTemplate="header">
                        <tr>
                            <th>Fecha</th>
                            <th>Nivel</th>
                            <th>Categor√≠a</th>
                            <th>Estado</th>
                            <th>Puntuaci√≥n</th>
                            <th>Intentos</th>
                            <th>Tiempo</th>
                            <th>Precisi√≥n</th>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="body" let-partida>
                        <tr [ngClass]="{'completed-row': partida.completada}">
                            <td>{{ formatearFecha(partida.fechaInicio) }}</td>
                            <td>
                                <p-tag
                                    [value]="getNivelLabel(partida.nivel)"
                                    [severity]="getNivelSeverity(partida.nivel)">
                                </p-tag>
                            </td>
                            <td>{{ getCategoriaLabel(partida.categoria) }}</td>
                            <td>
                                <p-tag
                                    [value]="partida.completada ? 'Completada' : 'Incompleta'"
                                    [severity]="partida.completada ? 'success' : 'warn'"
                                    [icon]="partida.completada ? 'pi pi-check' : 'pi pi-times'">
                                </p-tag>
                            </td>
                            <td><strong class="score-highlight">{{ partida.puntuacion }}</strong></td>
                            <td>{{ partida.intentos }}</td>
                            <td>{{ formatearTiempo(partida.tiempoSegundos) }}</td>
                            <td>
                                <div class="precision-mini-bar">
                                    <span class="precision-text">{{ partida.precision.toFixed(0) }}%</span>
                                    <div class="mini-progress" [style.width.%]="partida.precision"></div>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                    <ng-template pTemplate="emptymessage">
                        <tr>
                            <td colspan="8">
                                <div class="empty-table-state">
                                    <i class="pi pi-inbox"></i>
                                    <h3>No hay partidas registradas</h3>
                                    <p>Comienza a jugar para ver tu historial aqu√≠</p>
                                    <p-button
                                        label="Jugar Ahora"
                                        icon="pi pi-play"
                                        routerLink="/juegos/memoria-cultural">
                                    </p-button>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </div>
        </div>

    </div>

    <!-- Empty State Mejorado -->
    <div class="empty-state-modern" *ngIf="!cargando && estadisticas && estadisticas.resumenGeneral.totalPartidas === 0">
        <div class="empty-state-content">
            <div class="empty-state-illustration">
                <i class="pi pi-chart-bar"></i>
            </div>
            <h2>¬°Comienza Tu Aventura!</h2>
            <p>A√∫n no tienes estad√≠sticas. Juega tu primera partida y comienza a ver tu progreso aqu√≠.</p>
            <p-button
                label="Comenzar a Jugar"
                icon="pi pi-play"
                size="large"
                routerLink="/juegos/memoria-cultural">
            </p-button>
        </div>
    </div>
</div>
